<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
<title>Magic Item Compendium ‚Äî D&D 5e</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark:#1a1a2e; --bg-panel:#16213e; --text-light:#e8e8e8;
  --text-muted:#9a9ab0; --text-dim:#6a6a80; --gold:#c9a84c; --gold-dim:#8a6a2c; --border:#2a2a4a;
  --r-common:#7a7a8a; --r-uncommon:#2a7a3a; --r-rare:#2a3a8a; --r-very-rare:#6a2a8a; --r-legendary:#8a3a1a; --r-artifact:#8a6a0a;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'EB Garamond',Georgia,serif;background:var(--bg-dark);color:var(--text-light);min-height:100vh;background-image:radial-gradient(ellipse at 20% 50%,rgba(80,50,0,0.15) 0%,transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(0,20,80,0.15) 0%,transparent 60%);}
#app-header{position:sticky;top:0;z-index:100;background:rgba(22,33,62,0.97);border-bottom:1px solid var(--border);backdrop-filter:blur(12px);}
.header-top{display:flex;align-items:center;justify-content:space-between;padding:14px 24px 10px;border-bottom:1px solid rgba(255,255,255,0.05);}
.app-title{font-family:'Cinzel',serif;font-size:1.3rem;font-weight:900;letter-spacing:0.07em;color:var(--gold);text-shadow:0 0 20px rgba(201,168,76,0.4);text-transform:uppercase;}
.app-title span{color:var(--text-muted);font-weight:400;font-size:0.85rem;margin-left:8px;letter-spacing:0.18em;}
.nav-links{display:flex;gap:8px;align-items:center;}
.nav-link{font-family:'Cinzel',serif;font-size:0.7rem;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;text-decoration:none;border:1px solid var(--border);border-radius:4px;padding:5px 12px;color:var(--text-muted);transition:all 0.15s;}
.nav-link:hover{color:var(--gold);border-color:rgba(201,168,76,0.4);}
.filter-bar{display:flex;align-items:center;gap:8px;padding:10px 24px 12px;flex-wrap:wrap;}
.filter-label{font-family:'Cinzel',serif;font-size:0.68rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-dim);white-space:nowrap;}
select,input[type="text"]{font-family:'EB Garamond',serif;font-size:0.95rem;background:#0d1a30;color:#e8e8e8;border:1px solid #3a3a5a;border-radius:4px;padding:5px 10px;outline:none;transition:border-color 0.15s,background 0.15s;}
select{padding-right:28px;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23c9a84c'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;background-color:#0d1a30;cursor:pointer;}
select option{background:#0d1a30;color:#e8e8e8;}
select:focus,input[type="text"]:focus{border-color:var(--gold-dim);background:#111f38;box-shadow:0 0 0 2px rgba(201,168,76,0.15);}
input[type="text"]::placeholder{color:#6a6a80;}
.search-input{min-width:200px;flex:1;max-width:340px;}
.pill-filters{display:flex;gap:4px;flex-wrap:wrap;}
.pill{font-family:'Cinzel',serif;font-size:0.62rem;letter-spacing:0.06em;font-weight:600;border-radius:3px;padding:3px 8px;cursor:pointer;border:1px solid var(--border);background:rgba(255,255,255,0.04);color:var(--text-muted);transition:all 0.15s;user-select:none;}
.pill:hover{border-color:var(--text-dim);color:var(--text-light);}
.pill.active{background:rgba(201,168,76,0.18);border-color:var(--gold-dim);color:var(--gold);}
.rarity-pill.active[data-val="Common"]{background:#7a7a8a;color:#fff;border-color:transparent;}
.rarity-pill.active[data-val="Uncommon"]{background:#2a7a3a;color:#fff;border-color:transparent;}
.rarity-pill.active[data-val="Rare"]{background:#2a3a8a;color:#fff;border-color:transparent;}
.rarity-pill.active[data-val="Very Rare"]{background:#6a2a8a;color:#fff;border-color:transparent;}
.rarity-pill.active[data-val="Legendary"]{background:#8a3a1a;color:#fff;border-color:transparent;}
.rarity-pill.active[data-val="Artifact"]{background:#8a6a0a;color:#fff;border-color:transparent;}
.btn-reset{font-family:'Cinzel',serif;font-size:0.7rem;font-weight:600;letter-spacing:0.05em;text-transform:uppercase;border:1px solid var(--border);border-radius:4px;padding:5px 10px;cursor:pointer;background:transparent;color:var(--text-muted);transition:all 0.15s;white-space:nowrap;}
.btn-reset:hover{color:var(--gold);border-color:rgba(201,168,76,0.5);}
.filter-divider{width:1px;height:24px;background:var(--border);flex-shrink:0;}
#results-bar{padding:7px 24px;font-size:0.85rem;color:var(--text-dim);border-bottom:1px solid var(--border);font-style:italic;background:rgba(15,52,96,0.2);}
#card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px;padding:24px;}
#empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:100px 24px;text-align:center;color:var(--text-dim);}
#empty-state .rune{width:4rem;height:4rem;opacity:0.25;margin-bottom:20px;display:block;}
#empty-state h2{font-family:'Cinzel',serif;font-size:1.3rem;color:var(--text-muted);margin-bottom:10px;letter-spacing:0.05em;}
.item-card{background:#fff;border-radius:7px;overflow:hidden;cursor:pointer;box-shadow:0 3px 16px rgba(0,0,0,0.45);transition:transform 0.15s ease,box-shadow 0.15s ease;color:#222;font-family:'EB Garamond',Georgia,serif;font-size:0.83rem;line-height:1.4;border:2.5px solid transparent;}
.item-card:hover{transform:translateY(-4px);box-shadow:0 10px 36px rgba(0,0,0,0.6);}
.card-header{padding:9px 11px 7px;display:flex;align-items:flex-start;gap:8px;}
.item-icon{font-size:1.6rem;flex-shrink:0;line-height:1;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.2));}
.card-name-block{flex:1;min-width:0;}
.card-name{font-family:'Cinzel',serif;font-weight:700;font-size:clamp(0.62rem,1.9vw,0.84rem);letter-spacing:0.03em;text-transform:uppercase;color:#fff;line-height:1.2;text-shadow:0 1px 3px rgba(0,0,0,0.35);overflow-wrap:break-word;}
.card-subline{font-size:0.68rem;color:rgba(255,255,255,0.72);font-style:italic;margin-top:2px;display:block;}
.rarity-badge{font-family:'Cinzel',serif;font-weight:700;font-size:0.52rem;letter-spacing:0.07em;text-transform:uppercase;background:rgba(0,0,0,0.25);color:rgba(255,255,255,0.9);border-radius:3px;padding:2px 5px;flex-shrink:0;white-space:nowrap;margin-top:2px;}
.card-tags{padding:4px 11px 5px;background:#f7f5f0;border-top:1px solid #eee;display:flex;flex-wrap:wrap;gap:3px;}
.tag{font-family:'Cinzel',serif;font-size:0.5rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;border-radius:3px;padding:2px 5px;}
.tag.attune{background:#fff0e0;color:#a63;}
.tag.attune-class{background:#ffe8f0;color:#933;}
.tag.charges{background:#e8f0ff;color:#336;}
.tag.consumable{background:#f0ffe8;color:#363;}
.tag.cursed{background:#fee;color:#933;}
.card-desc{padding:6px 11px 8px;background:#fff;font-size:0.75rem;color:#333;line-height:1.42;}
#modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:1000;align-items:center;justify-content:center;padding:24px;backdrop-filter:blur(4px);}
#modal-overlay.active{display:flex;}
#modal-box{background:#fff;border-radius:10px;overflow:hidden;max-width:560px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 8px 48px rgba(0,0,0,0.7);color:#222;font-family:'EB Garamond',serif;}
.modal-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:14px 16px;position:sticky;top:0;}
.modal-title{font-family:'Cinzel',serif;font-weight:700;font-size:1.1rem;letter-spacing:0.05em;text-transform:uppercase;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,0.35);}
.modal-subtitle{font-size:0.82rem;color:rgba(255,255,255,0.75);font-style:italic;margin-top:2px;}
.modal-close{font-family:'Cinzel',serif;font-size:0.7rem;font-weight:600;background:rgba(0,0,0,0.25);border:none;color:rgba(255,255,255,0.9);border-radius:4px;padding:5px 12px;cursor:pointer;flex-shrink:0;transition:background 0.15s;}
.modal-close:hover{background:rgba(0,0,0,0.4);}
.modal-body{padding:16px;}
.modal-desc{font-size:0.9rem;color:#333;line-height:1.55;margin-bottom:14px;}
.modal-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:14px;}
.modal-note{background:#fdf8ee;border-radius:5px;padding:10px 12px;margin-top:12px;font-style:italic;font-size:0.88rem;color:#555;line-height:1.45;border-left:3px solid #c9a84c;}
.btn{font-family:'Cinzel',serif;font-size:0.75rem;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;border:none;border-radius:4px;padding:7px 16px;cursor:pointer;transition:all 0.15s ease;}
.btn-print{background:linear-gradient(135deg,#c9a84c,#8a6a2c);color:#1a1a2e;font-weight:700;box-shadow:0 2px 12px rgba(201,168,76,0.3);}
.btn-print:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(201,168,76,0.5);}
.btn-print:disabled{opacity:0.38;cursor:not-allowed;transform:none!important;box-shadow:none!important;}
.btn-ghost{font-family:'Cinzel',serif;font-size:0.7rem;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;border:1px solid var(--border);border-radius:4px;padding:5px 12px;cursor:pointer;background:transparent;color:var(--text-muted);transition:all 0.15s;white-space:nowrap;}
.btn-ghost:hover{color:var(--gold);border-color:rgba(201,168,76,0.4);}
.btn-ghost:disabled{opacity:0.3;cursor:not-allowed;}
.selection-badge{font-family:'Cinzel',serif;font-size:0.78rem;color:var(--gold);background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.3);border-radius:20px;padding:4px 13px;letter-spacing:0.05em;white-space:nowrap;}
.item-card{position:relative;}
.item-card.selected{box-shadow:0 0 0 3px rgba(201,168,76,0.5),0 8px 28px rgba(0,0,0,0.5)!important;transform:translateY(-4px);}
.select-indicator{position:absolute;top:7px;right:7px;width:20px;height:20px;border-radius:50%;border:2px solid rgba(255,255,255,0.8);background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;z-index:10;transition:all 0.12s ease;font-size:0.65rem;color:#fff;font-weight:700;line-height:1;pointer-events:none;}
.item-card.selected .select-indicator{background:var(--gold);border-color:#fff;}
#print-preview-overlay.active{display:flex;}
.print-preview-page-label{font-family:'Cinzel',serif;font-size:0.65rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-dim);margin-bottom:6px;}
.print-preview-page{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;background:#e8e4dc;padding:10px;border-radius:6px;}
.print-preview-page .item-card{font-size:0.48rem!important;cursor:default!important;}
.print-preview-page .item-card:hover{transform:none!important;}
.print-preview-page .card-name{font-size:0.52rem!important;}
.print-preview-page .card-header{padding:5px 7px!important;}
.print-preview-page .item-icon{font-size:0.9rem!important;}
.print-preview-page .tag{font-size:0.38rem!important;}
.print-preview-page .card-desc{font-size:0.44rem!important;padding:3px 7px 5px!important;line-height:1.28!important;}
.print-preview-page .select-indicator{display:none!important;}
@media print{
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}
  body>*:not(#print-output){display:none!important;}
  #print-output{display:block!important;}
  @page{size:A4 landscape;margin:0;}
  .print-page{page-break-after:always;display:grid!important;grid-template-columns:repeat(4,1fr)!important;grid-template-rows:repeat(2,1fr)!important;gap:3mm!important;padding:8mm!important;width:297mm!important;height:210mm!important;overflow:hidden!important;background:#fff!important;}
  .print-page:last-child{page-break-after:avoid;}
  .print-page .item-card{border-radius:4px!important;font-size:0.52rem!important;}
  .print-page .card-name{font-size:0.58rem!important;}
  .print-page .card-header{padding:5px 7px!important;}
  .print-page .item-icon{font-size:1rem!important;}
  .print-page .rarity-badge{font-size:0.44rem!important;}
  .print-page .tag{font-size:0.4rem!important;}
  .print-page .card-desc{font-size:0.5rem!important;padding:3px 7px 5px!important;line-height:1.3!important;}
}
#btn-filter-toggle{display:none;}
.tooltip-wrap{position:relative;display:inline-flex;align-items:center;gap:4px;}
.tooltip-icon{display:inline-flex;align-items:center;justify-content:center;width:13px;height:13px;border-radius:50%;border:1px solid var(--text-dim);color:var(--text-dim);font-size:0.6rem;font-family:sans-serif;font-style:normal;font-weight:700;cursor:default;line-height:1;flex-shrink:0;transition:border-color 0.15s,color 0.15s;}
.tooltip-wrap:hover .tooltip-icon{border-color:var(--gold);color:var(--gold);}
.tooltip-bubble{display:none;position:fixed;width:min(260px,80vw);background:#1e2d50;border:1px solid rgba(201,168,76,0.5);border-radius:8px;padding:10px 13px;font-family:'EB Garamond',serif;font-size:0.88rem;font-style:normal;font-weight:400;color:#f0f0f0;line-height:1.55;letter-spacing:0;text-transform:none;box-shadow:0 8px 32px rgba(0,0,0,0.7);z-index:500;pointer-events:none;white-space:normal;word-wrap:break-word;}
.tooltip-bubble::after{content:'';position:absolute;top:100%;left:var(--arrow-x,50%);transform:translateX(-50%);border:6px solid transparent;border-top-color:#1e2d50;}
.tooltip-bubble::before{content:'';position:absolute;top:100%;left:var(--arrow-x,50%);transform:translateX(-50%);border:7px solid transparent;border-top-color:rgba(201,168,76,0.5);margin-top:1px;}
.tooltip-wrap:hover .tooltip-bubble{display:block;}
@media(max-width:768px){
  #card-grid{grid-template-columns:1fr 1fr;gap:12px;padding:14px;}
  .header-top{padding:8px 14px;}
  .app-title{font-size:clamp(0.75rem,3.5vw,1rem);}
  .app-title span{display:none;}
  .btn-print,.btn-ghost,.selection-badge,.select-indicator{display:none!important;}
  #btn-filter-toggle{display:flex;align-items:center;gap:4px;font-size:0.7rem;padding:4px 10px;background:rgba(201,168,76,0.15);border:1px solid rgba(201,168,76,0.4);color:var(--gold);border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;font-weight:600;letter-spacing:0.05em;}
  .filter-bar{max-height:0;overflow:hidden;transition:max-height 0.3s ease;padding:0 14px;}
  .filter-bar.expanded{max-height:700px;padding:10px 14px 12px;}
}
@media(max-width:480px){#card-grid{grid-template-columns:1fr;}}
#print-output{display:none;}

/* ============================================================
   SHARED HAMBURGER NAV
   ============================================================ */
.nav-overlay {
  position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:998;
  opacity:0;pointer-events:none;transition:opacity 0.25s ease;
}
.nav-overlay.open{opacity:1;pointer-events:all;}
.nav-drawer {
  position:fixed;top:0;right:-310px;width:290px;height:100vh;
  background:rgba(13,20,45,0.99);border-left:1px solid var(--border);
  backdrop-filter:blur(16px);z-index:999;
  transition:right 0.28s cubic-bezier(0.4,0,0.2,1);
  display:flex;flex-direction:column;
}
.nav-drawer.open{right:0;}
.nav-drawer-header {
  display:flex;align-items:center;justify-content:space-between;
  padding:18px 20px;border-bottom:1px solid var(--border);flex-shrink:0;
}
.nav-drawer-title {
  font-family:'Cinzel',serif;font-size:0.75rem;font-weight:700;
  letter-spacing:0.18em;text-transform:uppercase;color:var(--gold);
}
.nav-close-btn {
  background:none;border:none;color:var(--text-muted);font-size:1.3rem;
  cursor:pointer;padding:4px 6px;line-height:1;border-radius:4px;transition:color 0.15s;
}
.nav-close-btn:hover{color:var(--text-light);}
.nav-scroll{flex:1;overflow-y:auto;padding:8px 0 24px;}
.nav-section-label {
  font-family:'Cinzel',serif;font-size:0.58rem;font-weight:700;
  letter-spacing:0.22em;text-transform:uppercase;color:var(--text-dim);
  padding:16px 20px 6px;display:block;
}
.nav-item {
  display:flex;align-items:center;gap:12px;padding:11px 20px;
  text-decoration:none;color:var(--text-muted);
  font-family:'Cinzel',serif;font-size:0.75rem;font-weight:600;
  letter-spacing:0.07em;text-transform:uppercase;
  border-left:3px solid transparent;transition:all 0.14s;
}
.nav-item:hover,.nav-item.active{
  color:var(--gold);background:rgba(201,168,76,0.07);border-left-color:var(--gold-dim);
}
.nav-item .ni{width:1.1rem;height:1.1rem;flex-shrink:0;opacity:0.75;}
.nav-item:hover .ni,.nav-item.active .ni{opacity:1;}
.hamburger-btn {
  background:none;border:1px solid var(--border);border-radius:6px;
  padding:7px 10px;cursor:pointer;display:flex;flex-direction:column;
  gap:5px;transition:border-color 0.15s;flex-shrink:0;
}
.hamburger-btn:hover{border-color:var(--gold-dim);}
.hamburger-btn span{
  display:block;width:20px;height:2px;background:var(--text-muted);
  border-radius:2px;transition:background 0.15s;
}
.hamburger-btn:hover span{background:var(--gold);}
</style>
</head>
<body>

<!-- SHARED NAV DRAWER -->
<div class="nav-overlay" id="nav-overlay" onclick="closeNav()"></div>
<nav class="nav-drawer" id="nav-drawer">
  <div class="nav-drawer-header">
    <span class="nav-drawer-title">The Tome</span>
    <button class="nav-close-btn" onclick="closeNav()">&#x2715;</button>
  </div>
  <div class="nav-scroll">
    <span class="nav-section-label">Home</span>
    <a href="index.html" class="nav-item">
      <svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      &nbsp;Hub
    </a>
    <span class="nav-section-label">Reference</span>
    <a href="spelltome.html" class="nav-item">
      <svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      &nbsp;Spell Tome
    </a>
    <a href="conditions.html" class="nav-item">
      <svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      &nbsp;Condition Codex
    </a>
    <a href="wildshape.html" class="nav-item">
      <svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>
      &nbsp;Wildshape &amp; Familiar
    </a>
    <a href="monsters.html" class="nav-item">
      <svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="M12.5 17h-1a1 1 0 0 0-1 1v2h3v-2a1 1 0 0 0-1-1z"/><path d="M12 2C6.5 2 2 6.5 2 12c0 3.04 1.36 5.75 3.5 7.59V20h13v-.41C20.64 17.75 22 15.04 22 12 22 6.5 17.5 2 12 2z"/></svg>
      &nbsp;Monster Codex
    </a>
    <a href="magic-items.html" class="nav-item active">
      <svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="6 3 18 3 22 9 12 22 2 9"/><line x1="2" y1="9" x2="22" y2="9"/><line x1="12" y1="3" x2="6" y2="9"/><line x1="12" y1="3" x2="18" y2="9"/></svg>
      &nbsp;Magic Item Compendium
    </a>
    <span class="nav-section-label">Table Tools</span>
    <a href="combat-tracker.html" class="nav-item">
      <svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" y1="19" x2="19" y2="13"/><line x1="16" y1="16" x2="20" y2="20"/><line x1="19" y1="21" x2="21" y2="19"/><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"/><line x1="5" y1="14" x2="9" y2="18"/><line x1="7" y1="17" x2="3" y2="21"/><line x1="3" y1="19" x2="5" y2="21"/></svg>
      &nbsp;Combat Tracker
    </a>
    <a href="dice-roller.html" class="nav-item">
      <svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="8" height="8" rx="1.5"/><rect x="13" y="3" width="8" height="8" rx="1.5"/><rect x="3" y="13" width="8" height="8" rx="1.5"/><rect x="13" y="13" width="8" height="8" rx="1.5"/><circle cx="7" cy="7" r="1" fill="currentColor" stroke="none"/><circle cx="17" cy="7" r="1" fill="currentColor" stroke="none"/><circle cx="7" cy="17" r="1" fill="currentColor" stroke="none"/><circle cx="17" cy="17" r="1" fill="currentColor" stroke="none"/></svg>
      &nbsp;Dice Roller
    </a>
      <span class="nav-section-label">Campaigns</span>
      <a href="campaign-tracker.html" class="nav-item">
        <svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
        &nbsp;Campaign Chronicle
      </a>
  </div>
</nav>

<div id="app-header">
  <div class="header-top">
    <div class="app-title">Magic Item Compendium <span>D&D 5e SRD</span></div>
    <div style="display:flex;align-items:center;gap:8px;">
      <span class="selection-badge" id="selection-count">0 selected</span>
      <button class="btn-ghost" id="btn-select-all" onclick="selectAllVisible()" disabled>Select All</button>
      <button class="btn-ghost" id="btn-clear" onclick="clearSelection()" disabled>Clear</button>
      <button class="btn btn-print" id="btn-print" onclick="openPrintPreview()" disabled>&#128424; Print to PDF</button>
      <button id="btn-filter-toggle" onclick="toggleFilters()">Filters <span id="toggle-arrow">‚ñº</span></button>
      <button class="hamburger-btn" onclick="openNav()" aria-label="Open navigation"><span></span><span></span><span></span></button>
    </div>
  </div>
  <div class="filter-bar" id="filter-bar">
    <label for="search-input" class="filter-label">Search</label>
    <input type="text" class="search-input" id="search-input" placeholder="Search magic items‚Ä¶" oninput="applyFilters()" aria-label="Search magic items">
    <div class="filter-divider"></div>
    <span class="filter-label">Rarity</span>
    <div class="pill-filters" id="rarity-pills">
      <button type="button" class="pill rarity-pill active" data-val="all" onclick="togglePill(this,'rarity')" aria-pressed="true">All</button>
      <button type="button" class="pill rarity-pill" data-val="Common" onclick="togglePill(this,'rarity')">Common</button>
      <button type="button" class="pill rarity-pill" data-val="Uncommon" onclick="togglePill(this,'rarity')">Uncommon</button>
      <button type="button" class="pill rarity-pill" data-val="Rare" onclick="togglePill(this,'rarity')">Rare</button>
      <button type="button" class="pill rarity-pill" data-val="Very Rare" onclick="togglePill(this,'rarity')">Very Rare</button>
      <button type="button" class="pill rarity-pill" data-val="Legendary" onclick="togglePill(this,'rarity')">Legendary</button>
    </div>
    <div class="filter-divider"></div>
    <span class="filter-label">Type</span>
    <div class="pill-filters" id="type-pills">
      <button type="button" class="pill active" data-val="all" onclick="togglePill(this,'type')" aria-pressed="true">All</button>
      <button type="button" class="pill" data-val="Weapon" onclick="togglePill(this,'type')">Weapon</button>
      <button type="button" class="pill" data-val="Armor" onclick="togglePill(this,'type')">Armour</button>
      <button type="button" class="pill" data-val="Wondrous" onclick="togglePill(this,'type')">Wondrous</button>
      <button type="button" class="pill" data-val="Ring" onclick="togglePill(this,'type')">Ring</button>
      <button type="button" class="pill" data-val="Rod" onclick="togglePill(this,'type')">Rod</button>
      <button type="button" class="pill" data-val="Staff" onclick="togglePill(this,'type')">Staff</button>
      <button type="button" class="pill" data-val="Wand" onclick="togglePill(this,'type')">Wand</button>
      <button type="button" class="pill" data-val="Potion" onclick="togglePill(this,'type')">Potion</button>
      <button type="button" class="pill" data-val="Scroll" onclick="togglePill(this,'type')">Scroll</button>
    </div>
    <div class="filter-divider"></div>
    <span class="filter-label tooltip-wrap">Attunement
      <span class="tooltip-icon">?</span>
      <span class="tooltip-bubble">Some magic items require a creature to <strong>attune</strong> to them before their properties can be used. Attuning takes a short rest focusing on the item. A creature can be attuned to a maximum of <strong>3 magic items</strong> at a time.</span>
    </span>
    <div class="pill-filters" id="attune-pills">
      <button type="button" class="pill active" data-val="all" onclick="togglePill(this,'attune')" aria-pressed="true">All</button>
      <button type="button" class="pill" data-val="yes" onclick="togglePill(this,'attune')">Required</button>
      <button type="button" class="pill" data-val="no" onclick="togglePill(this,'attune')">Not Required</button>
    </div>
    <button class="btn-reset" onclick="resetFilters()" style="margin-left:8px;">Reset</button>
  </div>
</div>
<div id="results-bar"></div>
<div id="card-grid"></div>
<div id="empty-state" style="display:none;">
  <svg class="rune" viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><circle cx="32" cy="32" r="28"/><path d="M32 14v36M14 32h36M20 20l24 24M44 20L20 44"/></svg>
  <h2>No Items Found</h2>
  <p>Adjust your filters to find your treasure.</p>
</div>
<div id="modal-overlay" onclick="handleOverlayClick(event)">
  <div id="modal-box"></div>
</div>
<!-- PRINT PREVIEW OVERLAY -->
<div id="print-preview-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:600;flex-direction:column;align-items:center;backdrop-filter:blur(4px);">
  <div style="width:100%;max-width:700px;display:flex;align-items:center;justify-content:space-between;padding:16px 24px;flex-shrink:0;border-bottom:1px solid var(--border);">
    <div>
      <div style="font-family:'Cinzel',serif;font-size:1rem;font-weight:700;color:var(--gold);letter-spacing:0.08em;text-transform:uppercase;">Print Preview</div>
      <div style="font-size:0.8rem;color:var(--text-muted);margin-top:2px;" id="preview-page-count"></div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn-ghost" onclick="closePrintPreview()">Cancel</button>
      <button class="btn btn-print" onclick="executePrint()">&#128424; Open Print Dialog</button>
    </div>
  </div>
  <div id="print-pages-container" style="flex:1;overflow-y:auto;padding:24px;width:100%;max-width:700px;display:flex;flex-direction:column;gap:20px;"></div>
</div>
<div id="print-output"></div>

<script>
const RARITY_COLORS = {
  Common:'#7a7a8a', Uncommon:'#2a7a3a', Rare:'#2a3a8a',
  'Very Rare':'#6a2a8a', Legendary:'#8a3a1a', Artifact:'#8a6a0a', Varies:'#5a5a4a'
};

const ITEMS = [
  // POTIONS
  {name:'Potion of Healing',icon:'üß™',rarity:'Common',type:'Potion',attune:false,consumable:true,
    desc:'You regain 2d4+2 hit points when you drink this potion. The potion\'s red liquid glimmers when agitated.',
    note:'The most universally useful item in D&D. Always worth carrying.'},
  {name:'Potion of Greater Healing',icon:'üß™',rarity:'Uncommon',type:'Potion',attune:false,consumable:true,
    desc:'You regain 4d4+4 hit points when you drink this potion.',
    note:'Effective from mid-tier onward. Average 14 HP. Good to stockpile in dungeon crawls.'},
  {name:'Potion of Superior Healing',icon:'üß™',rarity:'Rare',type:'Potion',attune:false,consumable:true,
    desc:'You regain 8d4+8 hit points when you drink this potion.',
    note:'Average 28 HP ‚Äî a significant mid-combat save at higher tiers.'},
  {name:'Potion of Supreme Healing',icon:'üß™',rarity:'Very Rare',type:'Potion',attune:false,consumable:true,
    desc:'You regain 10d4+20 hit points when you drink this potion.',
    note:'Average 45 HP. Worth every gold piece in high-tier play.'},
  {name:'Potion of Flying',icon:'üß™',rarity:'Very Rare',type:'Potion',attune:false,consumable:true,
    desc:'When you drink this potion, you gain a flying speed equal to your walking speed for 1 hour and can hover. If the effect ends while you are still in the air, you fall unless you have another means of flight.',
    note:'One hour is generous. Can be lifesaving or gamebreaking depending on the encounter.'},
  {name:'Potion of Heroism',icon:'üß™',rarity:'Rare',type:'Potion',attune:false,consumable:true,
    desc:'For 1 hour after drinking it, you gain 10 temporary hit points that last for 1 hour. For the same duration, you are under the effect of the Bless spell (no concentration required).',
    note:'One of the best potions ‚Äî 10 temp HP plus Bless without concentration.'},
  {name:'Potion of Invisibility',icon:'üß™',rarity:'Very Rare',type:'Potion',attune:false,consumable:true,
    desc:'When you drink it, you become invisible for 1 hour. Anything you wear or carry is invisible with you. The effect ends early if you attack or cast a spell.',
    note:'One of the most powerful single-use items in the game. One hour of full invisibility.'},
  {name:'Potion of Speed',icon:'üß™',rarity:'Very Rare',type:'Potion',attune:false,consumable:true,
    desc:'When you drink this potion, you gain the effect of the Haste spell for 1 minute (no concentration required). The yellow fluid moves and swirls like something alive.',
    note:'One minute of Haste without concentration. Exceptional in decisive combat.'},
  {name:'Potion of Clairvoyance',icon:'üß™',rarity:'Rare',type:'Potion',attune:false,consumable:true,
    desc:'When you drink this potion, you gain the effect of the Clairvoyance spell. An eyeball bobs in this yellow liquid but vanishes when the potion is opened.',
    note:'Recon utility in a bottle. Useful for scouting ahead of the party.'},
  {name:'Potion of Giant Strength',icon:'üß™',rarity:'Varies',type:'Potion',attune:false,consumable:true,
    desc:'When you drink this potion, your Strength score changes for 1 hour. The giant type determines the score: Hill (21), Stone/Frost (23), Fire (25), Cloud (27), Storm (29).',
    note:'Useful for non-Strength characters needing to grapple or break through obstacles. Storm variant sets Str to 29.'},
  {name:'Potion of Waterbreathing',icon:'üß™',rarity:'Uncommon',type:'Potion',attune:false,consumable:true,
    desc:'You can breathe underwater for 1 hour after drinking this potion. Its cloudy green fluid smells of the sea.',
    note:'Cheap insurance for aquatic encounters. Consider buying several before a seafloor dungeon.'},
  // SCROLLS
  {name:'Spell Scroll',icon:'üìú',rarity:'Varies',type:'Scroll',attune:false,consumable:true,source:'SRD 5.1',activation:'action',
    desc:'A spell scroll bears the words of a single spell, written in a mystical cipher. If the spell is on your class\'s spell list, you can read the scroll and cast its spell without providing any material components. Otherwise, the scroll is unintelligible. Casting the spell by reading the scroll requires the spell\'s normal casting time. Once the spell is cast, the words on the scroll fade and it crumbles to dust. If the spell is of a higher level than you can normally cast, you must make a spellcasting ability check using your spellcasting ability with a DC equal to 10 + the spell\'s level. On a failed check, the spell disappears from the scroll with no other effect.',
    note:'Rarity scales with spell level. Cantrip/1st: Common; 2nd-3rd: Uncommon; 4th-5th: Rare; 6th-8th: Very Rare; 9th: Legendary. Failed ability check destroys the scroll.'},
  // WEAPONS
  {name:'+1 Weapon',icon:'‚öîÔ∏è',rarity:'Uncommon',type:'Weapon',attune:false,
    desc:'You have a +1 bonus to attack and damage rolls made with this magic weapon.',
    note:'No attunement required. A straightforward and reliable upgrade for any martial character.'},
  {name:'+2 Weapon',icon:'‚öîÔ∏è',rarity:'Rare',type:'Weapon',attune:false,
    desc:'You have a +2 bonus to attack and damage rolls made with this magic weapon.',
    note:'No attunement. Also bypasses magical weapon resistance, which is critical in many encounters.'},
  {name:'+3 Weapon',icon:'‚öîÔ∏è',rarity:'Very Rare',type:'Weapon',attune:false,
    desc:'You have a +3 bonus to attack and damage rolls made with this magic weapon.',
    note:'No attunement. A +3 bonus at high levels is a meaningful difference in hit rate.'},
  {name:'Flame Tongue',icon:'üî•',rarity:'Rare',type:'Weapon',attune:true,charges:false,
    desc:'Use a bonus action to speak the command word ‚Äî flames erupt from the blade, shedding bright light 40 ft and dim light 40 ft further. The sword deals an extra 2d6 fire damage to any target it hits while ablaze.',
    note:'Attunement. +2d6 fire on demand. Highly effective against trolls, undead, and vegetation.'},
  {name:'Frost Brand',icon:'‚ùÑÔ∏è',rarity:'Very Rare',type:'Weapon',attune:true,source:'SRD 5.1',activation:'action',
    desc:'When you hit with an attack using this magic sword, the target takes an extra 1d6 cold damage. In addition, while you hold the sword, you have resistance to fire damage. When you draw this weapon, you can extinguish all nonmagical flames within 30 feet of you. This property can be used no more than once per hour. In freezing temperatures, the blade sheds bright light in a 10-foot radius and dim light for an additional 10 feet.',
    note:'Attunement. Fire resistance is exceptionally valuable. +1d6 cold damage is reliable bonus damage. The flame-extinguish feature is excellent for ambushes and stealth.'},
  {name:'Sword of Sharpness',icon:'‚öîÔ∏è',rarity:'Very Rare',type:'Weapon',attune:true,source:'SRD 5.1',activation:'action',
    desc:'When you attack an object with this magic sword and hit, maximize your weapon damage dice against the object. When you attack a creature with this weapon and roll a 20 on the attack roll, that target takes an extra 4d6 slashing damage. Then roll another d20. On a 19 or 20, you lop off one of the target\'s limbs, with the effect of such loss determined by the DM.',
    note:'Attunement. The dismemberment effect is iconic. Object-destroying capability makes it versatile. Note: the sever trigger is a 19‚Äì20 on the SECOND d20 roll, not the first.'},
  {name:'Sword of Life Stealing',icon:'‚öîÔ∏è',rarity:'Very Rare',type:'Weapon',attune:true,saveDC:15,source:'SRD 5.1',activation:'action',
    desc:'When you attack a creature with this weapon and roll a 20 on the attack roll, that creature must succeed on a DC 15 Constitution saving throw or its hit point maximum is reduced by 10 and you gain 10 temporary hit points. This reduction lasts until the creature finishes a long rest. A creature dies if its hit point maximum is reduced to 0.',
    note:'Attunement. HP maximum reduction persists until long rest (not permanent ‚Äî Greater Restoration not required). Excellent against solo bosses.'},
  {name:'Nine Lives Stealer',icon:'‚öîÔ∏è',rarity:'Very Rare',type:'Weapon',attune:true,charges:'1d8+1',saveDC:15,source:'SRD 5.1',activation:'action',destruction:'Becomes nonmagical when the last charge is expended',
    desc:'The sword has 1d8+1 charges. You can expend 1 charge when you hit a creature with this weapon if it has fewer than 100 hit points. The creature must succeed on a DC 15 Constitution saving throw or be slain instantly. The sword doesn\'t expend a charge if the target is immune to the effect. Creatures that are immune to being killed instantly, or that do not have a fixed number of hit points, are immune to this effect. When all charges are expended, the sword becomes a nonmagical weapon.',
    note:'Attunement. Instant death mechanic against creatures under 100 HP. Potent against humanoid enemies and minions. Becomes mundane once all charges are used.'},
  {name:'Dragon Slayer',icon:'üêâ',rarity:'Rare',type:'Weapon',attune:false,
    desc:'You gain a +1 bonus to attack and damage rolls. When you use this weapon to attack a dragon, you deal an extra 3d6 damage of the weapon\'s type.',
    note:'No attunement. +3d6 specifically vs dragons. Worth keeping available when draconic encounters are expected.'},
  {name:'Giant Slayer',icon:'üóø',rarity:'Rare',type:'Weapon',attune:false,
    desc:'You gain a +1 bonus to attack and damage rolls. When you hit a giant with it, the giant takes an extra 2d6 damage of the weapon\'s type and must make a DC 15 Strength save or fall prone.',
    note:'No attunement. +2d6 plus prone effect vs giants. Excellent for giant-heavy campaigns.'},
  {name:'Javelin of Lightning',icon:'üå©',rarity:'Uncommon',type:'Weapon',attune:false,
    desc:'When you hurl it and speak its command word, it transforms into a bolt of lightning ‚Äî a 5-ft-wide line 120 ft long. Each creature in the line (except you and the target) makes a DC 13 Dex save, taking 4d6 lightning on a failure. The lightning turns back into a javelin when it reaches the target. On a hit, the target takes weapon damage plus 4d6 lightning damage. The property can\'t be used again until the next dawn.',
    note:'Once per day AoE + single-target lightning damage. Excellent value at Uncommon rarity.'},
  {name:'Arrow of Slaying',icon:'üèπ',rarity:'Very Rare',type:'Weapon',attune:false,consumable:true,
    desc:'An arrow of slaying is a magic weapon meant to kill a particular kind of creature. When you hit a creature of that kind with this arrow and the creature has fewer than 100 HP, it must succeed on a DC 17 Constitution saving throw or be slain instantly.',
    note:'Consumable. Single-use instant death vs a specific creature type under 100 HP. Great for anticipated boss fights.'},
  {name:'Defender',icon:'üõ°',rarity:'Legendary',type:'Weapon',attune:true,
    desc:'The first time you attack with the sword on each of your turns, you can transfer some or all of the sword\'s +3 bonus to your Armor Class instead of using it for attacks. The adjusted bonuses remain until the start of your next turn.',
    note:'Attunement. A +3 weapon that can flex into AC. Exceptional defensive option ‚Äî effectively combines offense and defense.'},
  {name:'Holy Avenger',icon:'‚úùÔ∏è',rarity:'Legendary',type:'Weapon',attune:true,attuneClass:'Paladin',
    desc:'You gain a +3 bonus to attack and damage rolls made with this magic weapon. When you hit a fiend or an undead with it, that creature takes an extra 2d10 radiant damage. While you hold the drawn sword, it creates an aura in a 10-foot radius around you. You and all creatures friendly to you in the aura have advantage on saving throws against spells and other magical effects.',
    note:'Paladin attunement only. +3, radiant damage vs fiends/undead, and a party-wide magic resistance aura. The definitive paladin weapon.'},
  {name:'Vorpal Sword',icon:'‚öîÔ∏è',rarity:'Legendary',type:'Weapon',attune:true,
    desc:'You gain a +3 bonus to attack and damage rolls. The weapon ignores resistance to slashing damage. When you attack a creature that has at least one head with this weapon and roll a 20, you cut off one of its heads. The creature dies if it can\'t survive without the lost head.',
    note:'Attunement. Decapitation on a natural 20 ‚Äî even the Tarrasque can be beheaded. Ignores slashing resistance as standard.'},
  // ARMOR
  {name:'+1 Armor',icon:'üõ°',rarity:'Rare',type:'Armor',attune:false,
    desc:'You have a +1 bonus to AC while you wear this armor.',
    note:'No attunement. A reliable AC improvement that stacks with all other bonuses.'},
  {name:'+2 Armor',icon:'üõ°',rarity:'Very Rare',type:'Armor',attune:false,
    desc:'You have a +2 bonus to AC while you wear this armor.',
    note:'No attunement. +2 AC is significant at higher levels where each point changes saving throw odds.'},
  {name:'+3 Armor',icon:'üõ°',rarity:'Legendary',type:'Armor',attune:false,
    desc:'You have a +3 bonus to AC while you wear this armor.',
    note:'No attunement. The pinnacle of armor bonuses. Exceptionally rare and coveted.'},
  {name:'Adamantine Armor',icon:'üõ°',rarity:'Uncommon',type:'Armor',attune:false,
    desc:'While you\'re wearing it, any critical hit against you becomes a normal hit.',
    note:'No attunement. Negates all critical hits ‚Äî exceptionally powerful since crits deal double dice. Works on any non-natural armor.'},
  {name:'Mithral Armor',icon:'üõ°',rarity:'Uncommon',type:'Armor',attune:false,
    desc:'Mithral is a light, flexible metal. A mithral chain shirt or breastplate can be worn under normal clothes. The mithral version of the armor has no Stealth disadvantage or Strength requirement.',
    note:'No attunement. Removes Stealth disadvantage and Strength requirement. Excellent for multiclass and hybrid builds.'},
  {name:'Armor of Resistance',icon:'üõ°',rarity:'Rare',type:'Armor',attune:true,
    desc:'You have resistance to one type of damage while you wear this armor. The DM chooses the type or determines it randomly.',
    note:'Attunement. Resistance effectively halves all damage of that type ‚Äî transformative against specific enemies.'},
  {name:'Armor of Invulnerability',icon:'üõ°',rarity:'Legendary',type:'Armor',attune:true,
    desc:'You have resistance to nonmagical damage while you wear this armor. Additionally, you can use an action to make yourself immune to nonmagical damage for 10 minutes. Once used, this property can\'t be used again until the next dawn.',
    note:'Attunement. Permanent nonmagical damage resistance plus daily immunity. The ultimate tank armour item.'},
  {name:'Demon Armor',icon:'üòà',rarity:'Very Rare',type:'Armor',attune:true,cursed:true,
    desc:'While wearing this armor, you understand and can speak Abyssal. The clawed gauntlets turn unarmed strikes into magic weapons that deal slashing damage, with a +1 bonus to attack rolls and damage rolls and a damage die of 1d8. This armor is cursed ‚Äî once donned, you can\'t doff it unless targeted by Remove Curse or similar magic.',
    note:'Attunement. CURSED ‚Äî cannot be removed without Remove Curse. The clawed attacks and Abyssal language are real benefits, but exercise caution.'},
  // RINGS
  {name:'Ring of Protection',icon:'üíç',rarity:'Rare',type:'Ring',attune:true,
    desc:'You gain a +1 bonus to AC and saving throws while wearing this ring.',
    note:'Attunement. +1 to both AC and all saves from a single item. Exceptional versatility for one attunement slot.'},
  {name:'Ring of Spell Storing',icon:'üíç',rarity:'Rare',type:'Ring',attune:true,
    desc:'This ring stores spells cast into it, holding them until the attuned wearer uses them. The ring can store up to 5 levels worth of spells at a time. Any creature can cast a spell of 1st through 5th level into the ring.',
    note:'Attunement. The most flexible ring ‚Äî any creature can load it with spells that the attuned wearer can then cast on demand.'},
  {name:'Ring of Evasion',icon:'üíç',rarity:'Rare',type:'Ring',attune:true,charges:'3',recharge:'1d3 daily at dawn',source:'SRD 5.1',activation:'reaction',
    desc:'This ring has 3 charges, and it regains 1d3 expended charges daily at dawn. When you fail a Dexterity saving throw while wearing it, you can use your reaction to expend 1 charge to succeed on that saving throw instead.',
    note:'Attunement. Reaction success on a failed Dex save ‚Äî invaluable against AoE spells like Fireball that could knock out the party.'},
  {name:'Ring of Resistance',icon:'üíç',rarity:'Rare',type:'Ring',attune:true,source:'SRD 5.1',
    desc:'You have resistance to one damage type while wearing this ring, determined by the gem set into it: Pearl (acid), Tourmaline (cold), Garnet (fire), Sapphire (lightning), Jet (necrotic), Moonstone (poison), Amber (radiant), Spinel (thunder).',
    note:'Attunement. Resistance from a ring slot ‚Äî excellent if your armour slot is already dedicated elsewhere.'},
  {name:'Ring of Regeneration',icon:'üíç',rarity:'Very Rare',type:'Ring',attune:true,
    desc:'While wearing this ring, you regain 1d6 hit points every 10 minutes, provided that you have at least 1 hit point. If you lose a body part, the ring causes the missing part to regrow and return to full functionality after 1d6+1 days if you have at least 1 hit point throughout.',
    note:'Attunement. Passive regeneration ensures you recover between encounters. Limb regrowth removes one of the game\'s rare permanent penalties.'},
  {name:'Ring of Telekinesis',icon:'üíç',rarity:'Very Rare',type:'Ring',attune:true,
    desc:'While wearing this ring, you can cast the Telekinesis spell at will, but you can target only objects that aren\'t being worn or carried.',
    note:'Attunement. At-will Telekinesis on objects. Exceptional utility for puzzles, environmental control, and moving heavy obstacles.'},
  {name:'Ring of Spell Turning',icon:'üíç',rarity:'Legendary',type:'Ring',attune:true,
    desc:'While wearing this ring, you have advantage on saving throws against any spell that targets only you. In addition, if you roll a 20 on the save and the spell is 7th level or lower, the spell is reflected back onto the caster.',
    note:'Attunement. Advantage on single-target spells plus the chance to reflect them ‚Äî exceptional defensive item for any concentration-dependent target.'},
  {name:'Ring of Three Wishes',icon:'üíç',rarity:'Legendary',type:'Ring',attune:false,charges:'3',destruction:'Becomes nonmagical when the last charge is expended',source:'SRD 5.1',activation:'action',
    desc:'While wearing this ring, you can use an action to expend 1 of its 3 charges to cast the Wish spell from it. The ring becomes nonmagical when you use the last wish.',
    note:'No attunement. Three Wish spells. The most powerful item in the game. Use with extreme deliberation.'},
  // WONDROUS
  {name:'Bag of Holding',icon:'üëú',rarity:'Uncommon',type:'Wondrous',attune:false,
    desc:'This bag has an interior space considerably larger than its outside dimensions ‚Äî roughly 2 feet in diameter at the mouth and 4 feet deep. The bag can hold up to 500 pounds, not exceeding a volume of 64 cubic feet. The bag weighs 15 pounds regardless of its contents.',
    note:'No attunement. The quintessential utility item. Overloading or piercing it causes an implosion. Placing a bag of holding inside another extradimensional space tears a hole to the Astral Plane.'},
  {name:'Cloak of Elvenkind',icon:'üß•',rarity:'Uncommon',type:'Wondrous',attune:true,
    desc:'While you wear this cloak with its hood up, Wisdom (Perception) checks made to see you have disadvantage, and you have advantage on Dexterity (Stealth) checks made to hide, as the cloak\'s colour shifts to camouflage you.',
    note:'Attunement. Advantage on Stealth AND disadvantage on enemy Perception. The premier stealth item at Uncommon.'},
  {name:'Cloak of Protection',icon:'üß•',rarity:'Uncommon',type:'Wondrous',attune:true,
    desc:'You gain a +1 bonus to AC and saving throws while you wear this cloak.',
    note:'Attunement. +1 AC and +1 to all saves. Excellent for any character at any tier.'},
  {name:'Cloak of Displacement',icon:'üß•',rarity:'Rare',type:'Wondrous',attune:true,
    desc:'While you wear this cloak, it projects an illusion that makes you appear to be standing in a place near your actual location, causing any creature to have disadvantage on attack rolls against you. If you take damage, the property ceases to function until the start of your next turn.',
    note:'Attunement. Effectively gives permanent disadvantage on attacks ‚Äî one of the strongest defensive items in the game.'},
  {name:'Boots of Speed',icon:'üë¢',rarity:'Rare',type:'Wondrous',attune:true,charges:'10',recharge:'1d10 daily at dawn',depletionEffect:'Unusable at 0 charges until at least 1 charge is regained',source:'SRD 5.1',activation:'bonus action',
    desc:'While you wear these boots, you can use a bonus action and click the boots\' heels together to double your walking speed and allow you to move up to 10 feet as a reaction when a creature ends its turn within 5 feet of you. The effect lasts until you use a bonus action to click your heels together again. The boots expend 1 charge per minute of use. The boots have 10 charges and regain 1d10 expended charges daily at dawn. If the boots have 0 charges, they cease to function until at least 1 charge is restored.',
    note:'Attunement. Doubling movement speed is extremely strong for positioning, kiting, and escape. Effective for 10 minutes total per full recharge.'},
  {name:'Boots of Elvenkind',icon:'üë¢',rarity:'Uncommon',type:'Wondrous',attune:false,
    desc:'While you wear these boots, your steps make no sound regardless of the surface you are moving across. You also have advantage on Dexterity (Stealth) checks that involve moving quietly.',
    note:'No attunement. Advantage on Stealth for movement and silence. Excellent for rogues, rangers, and scout characters.'},
  {name:'Gauntlets of Ogre Power',icon:'üß§',rarity:'Uncommon',type:'Wondrous',attune:true,
    desc:'Your Strength score is 19 while you wear these gauntlets. They have no effect on you if your Strength is already 19 or higher.',
    note:'Attunement. Sets Strength to 19 ‚Äî transformative for low-Str characters needing to grapple, carry, or break things.'},
  {name:'Headband of Intellect',icon:'üëë',rarity:'Uncommon',type:'Wondrous',attune:true,
    desc:'Your Intelligence score is 19 while you wear this headband. It has no effect on you if your Intelligence is already 19 or higher.',
    note:'Attunement. Sets Int to 19. Transformative for non-Wizard Intelligence builds and Int-skill-heavy characters.'},
  {name:'Amulet of Health',icon:'üìø',rarity:'Rare',type:'Wondrous',attune:true,
    desc:'Your Constitution score is 19 while you wear this amulet. It has no effect on you if your Constitution is already 19 or higher.',
    note:'Attunement. Sets Con to 19 ‚Äî significantly boosts HP, concentration checks, and Con saves at lower Constitutions.'},
  {name:'Amulet of Proof against Detection',icon:'üìø',rarity:'Uncommon',type:'Wondrous',attune:true,
    desc:'While wearing this amulet, you are hidden from divination magic. You can\'t be targeted by such magic or perceived through magical scrying sensors.',
    note:'Attunement. Complete immunity to scrying and divination targeting. Excellent for characters hiding from powerful enemies.'},
  {name:'Decanter of Endless Water',icon:'üè∫',rarity:'Uncommon',type:'Wondrous',attune:false,
    desc:'You can use an action to say one of three command words to pour out fresh or salt water: Stream (1 gallon/round), Fountain (5 gallons/round), or Geyser (30 gallons/round ‚Äî a 30-ft long, 1-ft wide line dealing 1d4 bludgeoning damage, DC 13 Strength save or knocked prone).',
    note:'No attunement. Geyser can push and prone creatures. Also genuinely useful for survival and environmental puzzles.'},
  {name:'Eversmoking Bottle',icon:'üè∫',rarity:'Uncommon',type:'Wondrous',attune:false,
    desc:'When you use an action to remove the stopper, a cloud of thick smoke pours out in a 60-foot radius from the bottle. The cloud\'s area is heavily obscured. The cloud persists as long as the bottle is open. If the stopper is replaced, the cloud disperses after 10 minutes.',
    note:'No attunement. 60 ft radius of heavy obscurement on demand. Powerful area denial that affects all creatures equally.'},
  {name:'Eyes of Minute Seeing',icon:'üëÅ',rarity:'Uncommon',type:'Wondrous',attune:false,
    desc:'These crystal lenses fit over the eyes. While wearing them, you can see much better than normal out to a range of 1 foot. You have advantage on Intelligence (Investigation) checks that rely on sight while searching an area or studying an object within that range.',
    note:'No attunement. Advantage on Investigation within 1 ft ‚Äî useful for trap detection and document analysis.'},
  {name:'Eyes of the Eagle',icon:'ü¶Ö',rarity:'Uncommon',type:'Wondrous',attune:true,
    desc:'These crystal lenses fit over the eyes. While wearing them, you have advantage on Wisdom (Perception) checks that rely on sight. In conditions of clear visibility, you can make out details of even extremely distant creatures and objects as small as 2 feet across.',
    note:'Attunement. Advantage on sight-based Perception at any range. The best item for lookout and scout characters.'},
  {name:'Goggles of Night',icon:'ü•Ω',rarity:'Uncommon',type:'Wondrous',attune:false,
    desc:'While wearing these dark lenses, you have darkvision out to a range of 60 feet. If you already have darkvision, wearing the goggles increases its range by 60 feet.',
    note:'No attunement. Grants or extends darkvision by 60 ft. Excellent for human and any other non-darkvision races.'},
  {name:'Helm of Telepathy',icon:'‚õë',rarity:'Uncommon',type:'Wondrous',attune:true,
    desc:'While wearing this helm, you can use an action to cast the Detect Thoughts spell (save DC 13) from it. As long as you concentrate on the spell, you can use a bonus action to send a telepathic message to a creature you are focused on. It can reply with a bonus action.',
    note:'Attunement. At-will Detect Thoughts plus telepathic communication. Exceptional for social encounters and interrogation.'},
  {name:'Helm of Brilliance',icon:'‚ú®',rarity:'Very Rare',type:'Wondrous',attune:true,charges:'gems',
    desc:'This dazzling helm is set with diamonds, rubies, fire opals, and opals. You can use an action to cast a spell by expending a gem (the gem is destroyed): Diamond (Daylight), Ruby (Fireball, 10d6), Fire Opal (Prismatic Spray), Opal (Wall of Fire). The helm also sheds bright light 30 ft when adjacent to undead, and undead must save DC 15 or become blinded.',
    note:'Attunement. A hoard of spell gems. Multiple casting options, light effects, and undead repelling. Exceptional value.'},
  {name:'Ioun Stone of Awareness',icon:'üîÆ',rarity:'Rare',type:'Wondrous',attune:true,
    desc:'While this pale lavender ellipsoid is orbiting your head, you have advantage on Wisdom (Perception) checks and can\'t be surprised.',
    note:'Attunement. Cannot be surprised plus Perception advantage ‚Äî especially potent in ambush-heavy campaigns.'},
  {name:'Ioun Stone of Reserve',icon:'üîÆ',rarity:'Rare',type:'Wondrous',attune:true,
    desc:'This vibrant purple prism stores spells cast into it. While orbiting your head, it stores up to 3 levels of spells. Any creature can cast a 1st-, 2nd-, or 3rd-level spell into the stone by touching it, and you can cast that spell from the stone as a bonus action.',
    note:'Attunement. Stores spells as bonus-action casting. The bonus action cast element makes this extremely flexible.'},
  {name:'Necklace of Adaptation',icon:'üìø',rarity:'Uncommon',type:'Wondrous',attune:true,
    desc:'While wearing this necklace, you can breathe normally in any environment, and you have advantage on saving throws made against harmful gases and vapors (such as Cloudkill and Stinking Cloud effects).',
    note:'Attunement. Breathe anywhere ‚Äî underwater, in vacuum, through Cloudkill. Essential insurance for environmental hazard campaigns.'},
  {name:'Pearl of Power',icon:'üîÆ',rarity:'Uncommon',type:'Wondrous',attune:true,attuneClass:'Spellcaster',
    desc:'While this pearl is on your person, you can use an action to speak its command word and regain one expended spell slot of 3rd level or lower. The pearl can\'t be used again until the next dawn.',
    note:'Attunement (spellcaster). Daily regain of a spell slot up to 3rd level. Excellent value for concentration-intensive spellcasters.'},
  {name:'Portable Hole',icon:'‚ö´',rarity:'Rare',type:'Wondrous',attune:false,
    desc:'This fine black cloth, soft as silk, folds into a small package. When unfolded and spread on a solid surface, it creates a circular hole 6 feet in diameter and 10 feet deep. The cloth cannot be folded while the hole is in use. Creatures and objects can be placed inside; the interior has air for 10 minutes.',
    note:'No attunement. A 6-ft wide, 10-ft deep extradimensional space. If placed inside a Bag of Holding, it tears a rift to the Astral Plane.'},
  {name:'Ring of Invisibility',icon:'üíç',rarity:'Legendary',type:'Ring',attune:true,
    desc:'While wearing this ring, you can turn invisible as an action. Anything you wear or carry is invisible with you. You remain invisible until the ring is removed, until you attack or cast a spell, or until you use a bonus action to become visible again.',
    note:'Attunement. At-will invisibility without the one-hour limit of the potion. The premier stealth ring.'},
  // RODS / STAVES / WANDS
  {name:'Rod of Lordly Might',icon:'ü™Ñ',rarity:'Legendary',type:'Rod',attune:true,charges:'6 buttons',saveDC:17,source:'SRD 5.1',activation:'action',
    desc:'This rod has a flanged head and six buttons down one side. The rod can be wielded as a magic mace that grants a +3 bonus to attack and damage rolls. The rod has the following properties, each button activating a different function (one function active at a time): Button 1 ‚Äì Flame Blade: A fiery blade springs from the flanged head. The rod deals an extra 2d6 fire damage on a hit. Button 2 ‚Äì Drain Life: When you hit a creature, expend a charge to deal an extra 4d6 necrotic damage; you regain hit points equal to the necrotic damage dealt (DC 17 Constitution saving throw to negate). Button 3 ‚Äì Paralyse: A creature you hit must succeed on a DC 17 Strength saving throw or be paralysed for 1 minute. The creature repeats the save at the end of each of its turns. Button 4 ‚Äì Terrify: Each creature of your choice within 30 feet must make a DC 17 Wisdom saving throw or be frightened of you for 1 minute, repeating the save at the end of each of its turns. Button 5 ‚Äì Extendable Ladder: The rod elongates into a 50-foot ladder (bonus action to retract). Button 6 ‚Äì Siege Weapon: The rod becomes a +3 battering ram, granting +10 to Strength checks made to break down doors and similar barriers.',
    note:'Attunement. A multi-function legendary rod. Six distinct modes plus +3 weapon baseline. Fear and drain features are the combat highlights; ladder and siege mode provide exceptional utility.'},
  {name:'Rod of Security',icon:'ü™Ñ',rarity:'Very Rare',type:'Rod',attune:false,
    desc:'While holding this rod, you can use an action to activate it. The rod then instantly transports you and up to 199 other willing creatures you can see to a paradise that exists in an extradimensional space. You choose the form of the paradise: it can resemble any terrain you\'ve seen. While in the paradise, creatures don\'t age, eat, or sleep. This rod can\'t be used again until 10 days have passed.',
    note:'No attunement. Up to 200 creatures in an extradimensional paradise for up to 200 days. Exceptional for long rests and refuge.'},
  {name:'Staff of Fire',icon:'üî•',rarity:'Very Rare',type:'Staff',attune:true,attuneClass:'Druid/Sorcerer/Warlock/Wizard',charges:'10',recharge:'1d6+4 daily at dawn',destruction:'Roll d20 when last charge expended ‚Äî on a 1, staff is destroyed',source:'SRD 5.1',activation:'action',
    desc:'This staff has 10 charges. While holding it, you have resistance to fire damage. You can use an action to expend charges to cast: Burning Hands (1 charge), Fireball (3 charges), or Wall of Fire (4 charges). The staff regains 1d6+4 expended charges daily at dawn. If you expend the last charge, roll a d20; on a 1, the staff blackens, crumbles into cinders, and is destroyed.',
    note:'Attunement (druid/sorcerer/warlock/wizard). Fire resistance plus fire spell charges. Reliable AoE damage item.'},
  {name:'Staff of Healing',icon:'üåø',rarity:'Rare',type:'Staff',attune:true,attuneClass:'Bard/Cleric/Druid',charges:'10',recharge:'1d6+4 daily at dawn',source:'SRD 5.1',activation:'action',
    desc:'This staff has 10 charges. While holding it, you can use an action to expend charges to cast: Cure Wounds (1 charge per spell level, up to 4th), Lesser Restoration (2 charges), or Mass Cure Wounds (5 charges). The staff regains 1d6+4 expended charges daily at dawn.',
    note:'Attunement (bard/cleric/druid). Healing action economy from a staff. Mass Cure Wounds for 5 charges is excellent.'},
  {name:'Staff of Power',icon:'‚ö°',rarity:'Very Rare',type:'Staff',attune:true,attuneClass:'Sorcerer/Warlock/Wizard',charges:'20',recharge:'2d8+4 daily at dawn',destruction:'Can be broken for Retributive Strike (expends all charges; 16√ócharges force damage in 30-ft radius, DC 17 Dex save for half); roll d20 on last charge ‚Äî on 1, staff is destroyed',source:'SRD 5.1',activation:'action',
    desc:'This staff has 20 charges and can be used as a +2 quarterstaff. Holding it, you gain +2 to AC, saving throws, and spell attack rolls. It holds numerous powerful spells (Cone of Cold, Fireball, Globe of Invulnerability, Hold Monster, Lightning Bolt, Magic Missile, Ray of Enfeeblement, Wall of Force) costing 1-5 charges. It can also be broken for a Retributive Strike.',
    note:'Attunement. One of the most powerful staves. +2 to AC/saves/attacks plus a huge repertoire of high-level spells.'},
  {name:'Staff of the Magi',icon:'‚ö°',rarity:'Legendary',type:'Staff',attune:true,attuneClass:'Sorcerer/Warlock/Wizard',charges:'50',
    desc:'This staff has 50 charges and can be used as a +2 quarterstaff. While holding it, you gain +2 to AC, saving throws, and spell attack rolls. It can absorb spells targeted at you (gaining charges equal to the absorbed spell\'s level). You can use charges to cast dozens of spells including Arcane Lock, Conjure Elemental, Dispel Magic, Fireball, Flaming Sphere, Fly, Ice Storm, Invisibility, Knock, Lightning Bolt, Passwall, Plane Shift, Telekinesis, Wall of Fire, and Web. You can also use an action to break it for a Retributive Strike.',
    note:'Attunement. 50 charges, spell absorption, +2 to three statistics, and the most complete spell list of any staff. The legendary spellcaster staff.'},
  {name:'Wand of Fireballs',icon:'ü™Ñ',rarity:'Rare',type:'Wand',attune:true,attuneClass:'Spellcaster',charges:'7',recharge:'1d6+1 daily at dawn',saveDC:15,source:'SRD 5.1',activation:'action',
    desc:'This wand has 7 charges. While holding it, you can use an action to expend charges to cast Fireball (save DC 15) from it. For 1 charge, Fireball deals 8d6 fire damage. For each additional charge, the damage increases by 1d6. The wand regains 1d6+1 expended charges daily at dawn.',
    note:'Attunement (spellcaster). Reliable Fireball from a wand ‚Äî up to 13d6 at max charge. Excellent action economy for non-evocation wizards.'},
  {name:'Wand of Magic Detection',icon:'ü™Ñ',rarity:'Uncommon',type:'Wand',attune:false,charges:'3',recharge:'1d3 daily at dawn',source:'SRD 5.1',activation:'action',
    desc:'This wand has 3 charges. While holding it, you can expend 1 charge as an action to cast the Detect Magic spell from it. The wand regains 1d3 expended charges daily at dawn.',
    note:'No attunement. At-will Detect Magic effectively. Excellent for item identification and trap detection.'},
  {name:'Wand of Magic Missiles',icon:'ü™Ñ',rarity:'Uncommon',type:'Wand',attune:false,charges:'7',source:'SRD 5.1',activation:'action',
    desc:'This wand has 7 charges. While holding it, you can use an action to expend 1 or more of its charges to cast Magic Missile from it. For 1 charge, you cast the 1st-level version of the spell. You can increase the spell slot level by one for each additional charge you expend.',
    note:'No attunement. Auto-hit Magic Missile from any character. Up to 7th-level slots for maximum bolts.'},
  {name:'Wand of Paralysis',icon:'ü™Ñ',rarity:'Rare',type:'Wand',attune:true,attuneClass:'Spellcaster',charges:'7',saveDC:15,source:'SRD 5.1',activation:'action',
    desc:'This wand has 7 charges. While holding it, you can use an action to expend 1 of its charges to cause a thin blue ray to streak from the tip toward a creature you can see within 60 feet of you. The target must succeed on a DC 15 Constitution saving throw or be paralyzed for 1 minute. At the end of each of the target\'s turns, it can repeat the saving throw. On a success, the effect ends.',
    note:'Attunement (spellcaster). 7 charges of Paralysis ‚Äî the melee auto-crit condition. Exceptional in high-priority target encounters.'},
  {name:'Wand of Polymorph',icon:'ü™Ñ',rarity:'Very Rare',type:'Wand',attune:true,attuneClass:'Spellcaster',charges:'7',recharge:'1d6+1 daily at dawn',saveDC:15,source:'SRD 5.1',activation:'action',
    desc:'This wand has 7 charges. While holding it, you can use an action to expend 1 of its charges to cast the Polymorph spell (save DC 15) from it. The wand regains 1d6+1 expended charges daily at dawn.',
    note:'Attunement (spellcaster). 7 uses of Polymorph per dawn cycle. Exceptional utility ‚Äî combat removal, transformation, and creative problem solving.'},
];

const RARITY_ORDER = ['Common','Uncommon','Rare','Very Rare','Legendary','Artifact','Varies'];

let activeRarity = new Set(['all']);
let activeType = new Set(['all']);
let activeAttune = new Set(['all']);
let searchQ = '';

function togglePill(pill, group) {
  const val = pill.dataset.val;
  const sets = {rarity: activeRarity, type: activeType, attune: activeAttune};
  const set = sets[group];
  const pillsId = group+'-pills';
  if (val === 'all') { set.clear(); set.add('all'); }
  else {
    set.delete('all');
    if (set.has(val)) { set.delete(val); if (set.size === 0) set.add('all'); }
    else set.add(val);
  }
  document.querySelectorAll(`#${pillsId} .pill`).forEach(p => {
    p.classList.toggle('active', set.has(p.dataset.val));
  });
  renderGrid();
}

function applyFilters() { searchQ = document.getElementById('search-input').value.toLowerCase().trim(); renderGrid(); }

function resetFilters() {
  document.getElementById('search-input').value = '';
  searchQ = '';
  activeRarity = new Set(['all']); activeType = new Set(['all']); activeAttune = new Set(['all']);
  document.querySelectorAll('.pill').forEach(p => {
    p.classList.toggle('active', p.dataset.val === 'all');
    if (p.classList.contains('rarity-pill')) { p.style.background=''; p.style.color=''; p.style.borderColor=''; }
  });
  renderGrid();
}

function filtered() {
  return ITEMS.filter(item => {
    const rarityOk = activeRarity.has('all') || activeRarity.has(item.rarity);
    const typeOk = activeType.has('all') || activeType.has(item.type);
    let attuneOk = true;
    if (!activeAttune.has('all')) {
      if (activeAttune.has('yes') && !item.attune) attuneOk = false;
      if (activeAttune.has('no') && item.attune) attuneOk = false;
    }
    const searchOk = !searchQ ||
      item.name.toLowerCase().includes(searchQ) ||
      item.desc.toLowerCase().includes(searchQ) ||
      item.type.toLowerCase().includes(searchQ) ||
      item.rarity.toLowerCase().includes(searchQ);
    return rarityOk && typeOk && attuneOk && searchOk;
  });
}

function rarityColor(r) { return RARITY_COLORS[r] || '#555'; }

const selectedItems = new Set();

function buildCard(item, forPreview) {
  const color = rarityColor(item.rarity);
  const tags = [];
  if (item.attune) tags.push(`<span class="tag attune">${item.attuneClass ? 'Attune: '+item.attuneClass : 'Attunement'}</span>`);
  if (item.charges) tags.push(`<span class="tag charges">${typeof item.charges === 'string' ? item.charges : item.charges+' charges'}</span>`);
  if (item.consumable) tags.push(`<span class="tag consumable">Consumable</span>`);
  if (item.cursed) tags.push(`<span class="tag cursed" style="background:#fee;color:#933;">Cursed</span>`);
  const shortDesc = item.desc.length > 200 ? item.desc.substring(0, 197) + '‚Ä¶' : item.desc;
  const indicator = forPreview ? '' : `<div class="select-indicator"></div>`;
  return `<div class="item-card${selectedItems.has(item.name)?' selected':''}" style="border-color:${color}20">
    ${indicator}
    <div class="card-header" style="background:${color}">
      <span class="item-icon">${item.icon}</span>
      <div class="card-name-block">
        <div class="card-name">${item.name}</div>
        <span class="card-subline">${item.type} ¬∑ ${item.rarity}</span>
      </div>
    </div>
    ${tags.length ? `<div class="card-tags">${tags.join('')}</div>` : ''}
    <div class="card-desc">${shortDesc}</div>
  </div>`;
}

function toggleSelect(item, cardEl) {
  if (selectedItems.has(item.name)) {
    selectedItems.delete(item.name);
    cardEl.classList.remove('selected');
    cardEl.querySelector('.select-indicator').innerHTML = '';
  } else {
    selectedItems.add(item.name);
    cardEl.classList.add('selected');
    cardEl.querySelector('.select-indicator').innerHTML = '&#10003;';
  }
  updateSelectionUI();
}

function selectAllVisible() {
  filtered().forEach(item => {
    selectedItems.add(item.name);
  });
  document.querySelectorAll('#card-grid .item-card').forEach(el => {
    el.classList.add('selected');
    el.querySelector('.select-indicator').innerHTML = '&#10003;';
  });
  updateSelectionUI();
}

function clearSelection() {
  selectedItems.clear();
  document.querySelectorAll('#card-grid .item-card.selected').forEach(el => {
    el.classList.remove('selected');
    el.querySelector('.select-indicator').innerHTML = '';
  });
  updateSelectionUI();
}

function updateSelectionUI() {
  const count = selectedItems.size;
  const visibleCount = document.querySelectorAll('#card-grid .item-card').length;
  document.getElementById('selection-count').textContent = `${count} selected`;
  document.getElementById('btn-print').disabled = count === 0;
  document.getElementById('btn-clear').disabled = count === 0;
  document.getElementById('btn-select-all').disabled = visibleCount === 0;
  const total = visibleCount;
  document.getElementById('results-bar').textContent =
    `${total} item${total!==1?'s':''} shown${count > 0 ? ` ¬∑ ${count} selected` : ''}`;
}

function renderGrid() {
  const list = filtered();
  const grid = document.getElementById('card-grid');
  const empty = document.getElementById('empty-state');
  if (!list.length) { grid.innerHTML = ''; empty.style.display = 'flex'; updateSelectionUI(); return; }
  empty.style.display = 'none';
  grid.innerHTML = list.map(item => buildCard(item, false)).join('');
  // Restore tick on already-selected cards
  const onMobile = () => window.matchMedia('(pointer: coarse)').matches || window.innerWidth <= 768;
  grid.querySelectorAll('.item-card').forEach((el, i) => {
    if (selectedItems.has(list[i].name)) el.querySelector('.select-indicator').innerHTML = '&#10003;';
    if (onMobile()) {
      el.addEventListener('click', e => { openModal(list[i]); });
    } else {
      el.addEventListener('click', e => { toggleSelect(list[i], el); });
      el.addEventListener('dblclick', e => { openModal(list[i]); });
    }
  });
  updateSelectionUI();
}

function openModal(item) {
  const color = rarityColor(item.rarity);
  const box = document.getElementById('modal-box');
  const tags = [];
  if (item.attune) tags.push(`<span class="tag attune" style="font-size:0.65rem;padding:3px 8px;">${item.attuneClass ? 'Attunement: '+item.attuneClass : 'Requires Attunement'}</span>`);
  if (item.charges) tags.push(`<span class="tag charges" style="font-size:0.65rem;padding:3px 8px;">${typeof item.charges === 'string' ? 'Charges: '+item.charges : item.charges+' Charges'}</span>`);
  if (item.consumable) tags.push(`<span class="tag consumable" style="font-size:0.65rem;padding:3px 8px;">Consumable</span>`);
  if (item.cursed) tags.push(`<span class="tag cursed" style="font-size:0.65rem;padding:3px 8px;background:#fee;color:#933;">Cursed</span>`);
  box.innerHTML = `
    <div class="modal-header" style="background:${color}">
      <div>
        <div class="modal-title">${item.icon} ${item.name}</div>
        <div class="modal-subtitle">${item.type} ¬∑ ${item.rarity}${item.attune?' ¬∑ Requires Attunement':''}</div>
      </div>
      <button class="modal-close" onclick="closeModal()">Close</button>
    </div>
    <div class="modal-body">
      ${tags.length ? `<div class="modal-tags">${tags.join('')}</div>` : ''}
      <div class="modal-desc">${item.desc}</div>
      ${item.note ? `<div class="modal-note">${item.note}</div>` : ''}
    </div>`;
  document.getElementById('modal-overlay').classList.add('active');
}

function handleOverlayClick(e) { if(e.target===document.getElementById('modal-overlay')) closeModal(); }
function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); }

// Smart tooltip positioning ‚Äî keeps bubble within viewport
document.querySelectorAll('.tooltip-wrap').forEach(wrap => {
  const bubble = wrap.querySelector('.tooltip-bubble');
  if (!bubble) return;
  wrap.addEventListener('mouseenter', () => {
    bubble.style.display = 'block';
    const icon = wrap.querySelector('.tooltip-icon') || wrap;
    const ir = icon.getBoundingClientRect();
    const bw = bubble.offsetWidth;
    const bh = bubble.offsetHeight;
    const margin = 10;
    // Default: centred above icon
    let left = ir.left + ir.width / 2 - bw / 2;
    let top  = ir.top - bh - 10;
    // Clamp horizontally
    if (left < margin) left = margin;
    if (left + bw > window.innerWidth - margin) left = window.innerWidth - bw - margin;
    // If no room above, flip below
    if (top < margin) {
      top = ir.bottom + 10;
      bubble.style.setProperty('--arrow-top', 'auto');
    }
    bubble.style.left = left + 'px';
    bubble.style.top  = top  + 'px';
    // Reposition ::after arrow to match actual horizontal centre of icon
    const arrowLeft = (ir.left + ir.width / 2 - left);
    bubble.style.setProperty('--arrow-x', arrowLeft + 'px');
  });
  wrap.addEventListener('mouseleave', () => { bubble.style.display = 'none'; });
});

document.addEventListener('keydown', e => {
  if(e.key==='Escape') { closeModal(); closePrintPreview(); }
});

function toggleFilters() {
  const bar = document.getElementById('filter-bar');
  bar.classList.toggle('expanded');
  document.getElementById('toggle-arrow').textContent = bar.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
}

function openPrintPreview() {
  const items = ITEMS.filter(item => selectedItems.has(item.name));
  const pages = [];
  for (let i=0; i<items.length; i+=8) pages.push(items.slice(i,i+8));
  const container = document.getElementById('print-pages-container');
  container.innerHTML = '';
  pages.forEach((page, idx) => {
    const lbl = document.createElement('div');
    lbl.className = 'print-preview-page-label';
    lbl.textContent = `Page ${idx+1} of ${pages.length}`;
    container.appendChild(lbl);
    const pageEl = document.createElement('div');
    pageEl.className = 'print-preview-page';
    pageEl.innerHTML = page.map(item => buildCard(item, true)).join('');
    container.appendChild(pageEl);
  });
  document.getElementById('preview-page-count').textContent =
    `${items.length} card${items.length!==1?'s':''} ¬∑ ${pages.length} page${pages.length!==1?'s':''}`;
  const overlay = document.getElementById('print-preview-overlay');
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closePrintPreview() {
  document.getElementById('print-preview-overlay').classList.remove('active');
  document.body.style.overflow = '';
}

function executePrint() {
  const items = ITEMS.filter(item => selectedItems.has(item.name));
  const pages = [];
  for (let i=0; i<items.length; i+=8) pages.push(items.slice(i,i+8));
  const output = document.getElementById('print-output');
  output.innerHTML = pages.map(page =>
    `<div class="print-page">${page.map(item => buildCard(item, true)).join('')}</div>`
  ).join('');
  closePrintPreview();
  setTimeout(() => { window.print(); setTimeout(() => { output.innerHTML = ''; }, 1500); }, 100);
}

renderGrid();
</script>

<script>
function openNav() {
  document.getElementById('nav-drawer').classList.add('open');
  document.getElementById('nav-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeNav() {
  document.getElementById('nav-drawer').classList.remove('open');
  document.getElementById('nav-overlay').classList.remove('open');
  document.body.style.overflow = '';
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeNav(); });
</script>
</body>
</html>
