<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
<title>Monster Codex ‚Äî D&D 5e Quick Reference</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark:#1a1a2e; --bg-panel:#16213e; --text-light:#e8e8e8;
  --text-muted:#9a9ab0; --text-dim:#6a6a80; --gold:#c9a84c;
  --gold-dim:#8a6a2c; --border:#2a2a4a; --shadow:0 4px 24px rgba(0,0,0,0.5);
  --t-aberration:#6a3a8a; --t-beast:#4a7a2a; --t-celestial:#b8902a;
  --t-construct:#5a6a7a; --t-dragon:#8a2a2a; --t-elemental:#3a6a8a;
  --t-fey:#c4306a; --t-fiend:#7a1a1a; --t-giant:#7a5a2a;
  --t-humanoid:#4a5a6a; --t-monstrosity:#5a3a6a; --t-ooze:#3a7a3a;
  --t-plant:#2a6a3a; --t-undead:#3a3a5a;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'EB Garamond', Georgia, serif;
  background: var(--bg-dark); color: var(--text-light); min-height: 100vh;
  background-image:
    radial-gradient(ellipse at 20% 50%, rgba(80,0,0,0.15) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 20%, rgba(0,60,80,0.15) 0%, transparent 60%);
}
#app-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(22,33,62,0.97); border-bottom: 1px solid var(--border);
  backdrop-filter: blur(12px);
}
.header-top {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 24px 10px; border-bottom: 1px solid rgba(255,255,255,0.05);
}
.app-title {
  font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 900;
  letter-spacing: 0.08em; color: var(--gold);
  text-shadow: 0 0 20px rgba(201,168,76,0.4); text-transform: uppercase;
}
.app-title span { color: var(--text-muted); font-weight: 400; font-size: 0.9rem; margin-left: 8px; letter-spacing: 0.2em; }
.nav-links { display: flex; gap: 8px; align-items: center; }
.nav-link {
  font-family: 'Cinzel', serif; font-size: 0.7rem; font-weight: 600;
  letter-spacing: 0.08em; text-transform: uppercase; text-decoration: none;
  border: 1px solid var(--border); border-radius: 4px; padding: 5px 12px;
  color: var(--text-muted); transition: all 0.15s;
}
.nav-link:hover { color: var(--gold); border-color: rgba(201,168,76,0.4); }
.filter-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 24px 12px; flex-wrap: wrap;
}
.filter-label {
  font-family: 'Cinzel', serif; font-size: 0.68rem;
  letter-spacing: 0.1em; text-transform: uppercase;
  color: var(--text-dim); white-space: nowrap;
}
select, input[type="text"] {
  font-family: 'EB Garamond', serif; font-size: 0.95rem;
  background: #0d1a30; color: #e8e8e8; border: 1px solid #3a3a5a;
  border-radius: 4px; padding: 5px 10px; outline: none;
  transition: border-color 0.15s, background 0.15s;
}
select {
  padding-right: 28px; appearance: none; -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23c9a84c'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 8px center;
  background-color: #0d1a30; cursor: pointer;
}
select option { background: #0d1a30; color: #e8e8e8; }
select:focus, input[type="text"]:focus {
  border-color: var(--gold-dim); background: #111f38;
  box-shadow: 0 0 0 2px rgba(201,168,76,0.15);
}
input[type="text"]::placeholder { color: #6a6a80; }
.search-input { min-width: 180px; }
.pill-filters { display: flex; gap: 4px; flex-wrap: wrap; align-items: center; }
.pill {
  font-family: 'Cinzel', serif; font-size: 0.58rem; letter-spacing: 0.06em;
  font-weight: 600; border-radius: 3px; padding: 3px 7px;
  cursor: pointer; border: 1px solid var(--border);
  background: rgba(255,255,255,0.04); color: var(--text-muted);
  transition: all 0.15s; user-select: none;
}
.pill:hover { border-color: var(--text-dim); color: var(--text-light); }
.pill.active { background: rgba(201,168,76,0.18); border-color: var(--gold-dim); color: var(--gold); }
.btn-reset {
  font-family: 'Cinzel', serif; font-size: 0.7rem; font-weight: 600;
  letter-spacing: 0.05em; text-transform: uppercase;
  border: 1px solid var(--border); border-radius: 4px; padding: 5px 10px;
  cursor: pointer; background: transparent; color: var(--text-muted);
  transition: all 0.15s; white-space: nowrap; flex-shrink: 0;
}
.btn-reset:hover { color: var(--gold); border-color: rgba(201,168,76,0.5); }
.filter-divider { width: 1px; height: 24px; background: var(--border); flex-shrink: 0; }
#results-bar {
  padding: 7px 24px; font-size: 0.85rem; color: var(--text-dim);
  border-bottom: 1px solid var(--border); font-style: italic;
  background: rgba(15,52,96,0.2);
}
#card-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 18px; padding: 24px;
}
#empty-state {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 100px 24px; text-align: center; color: var(--text-dim);
}
#empty-state .rune { font-size: 4rem; opacity: 0.25; margin-bottom: 20px; display: block; }
#empty-state h2 { font-family: 'Cinzel', serif; font-size: 1.3rem; color: var(--text-muted); margin-bottom: 10px; letter-spacing: 0.05em; }

/* MONSTER CARD */
.mon-card {
  background: #fff; border-radius: 7px; overflow: hidden;
  cursor: pointer; position: relative;
  box-shadow: 0 3px 16px rgba(0,0,0,0.45);
  transition: transform 0.15s ease, box-shadow 0.15s ease;
  color: #222; font-family: 'EB Garamond', Georgia, serif;
  font-size: 0.83rem; line-height: 1.4;
  border: 2.5px solid transparent;
}
.mon-card:hover { transform: translateY(-4px); box-shadow: 0 10px 36px rgba(0,0,0,0.6); }
.card-header {
  padding: 9px 11px; display: flex; align-items: flex-start;
  gap: 8px; position: relative;
}
.card-name {
  font-family: 'Cinzel', serif; font-weight: 700;
  font-size: clamp(0.7rem, 2vw, 0.9rem); letter-spacing: 0.03em;
  text-transform: uppercase; color: #fff; flex: 1; line-height: 1.2;
  text-shadow: 0 1px 3px rgba(0,0,0,0.35); overflow-wrap: break-word;
}
.cr-badge {
  font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.75rem;
  background: rgba(0,0,0,0.25); color: rgba(255,255,255,0.95);
  border-radius: 3px; padding: 2px 7px; flex-shrink: 0;
  white-space: nowrap;
}
.card-subtype {
  font-size: 0.72rem; color: rgba(255,255,255,0.75);
  font-style: italic; margin-top: 1px; display: block;
}
.card-stats-block {
  padding: 7px 11px 5px; background: #fff;
  display: grid; grid-template-columns: 1fr 1fr; gap: 1px 8px;
}
.stat-row {
  display: flex; align-items: baseline; gap: 4px; min-width: 0;
}
.stat-label { font-size: 0.68rem; color: #777; flex-shrink: 0; min-width: 26px; }
.stat-val { font-weight: 600; font-size: 0.8rem; color: #111; white-space: nowrap; }
.card-traits {
  padding: 4px 11px 5px; background: #f7f5f0;
  border-top: 1px solid #eee; display: flex; flex-wrap: wrap; gap: 3px;
}
.trait-tag {
  font-family: 'Cinzel', serif; font-size: 0.52rem; font-weight: 700;
  letter-spacing: 0.05em; text-transform: uppercase; border-radius: 3px;
  padding: 2px 6px; background: #eee; color: #555;
}
.trait-tag.dmg-immune { background: #fee; color: #933; }
.trait-tag.dmg-resist { background: #fff0e0; color: #a63; }
.trait-tag.cond-immune { background: #e8eeff; color: #338; }
.trait-tag.legendary { background: #fdf0c0; color: #7a5500; }
.trait-tag.spellcaster { background: #f0e8ff; color: #553; }
.card-abilities {
  padding: 5px 11px 7px; background: #fff; border-top: 1px solid #eee;
  font-size: 0.75rem; color: #333; line-height: 1.4;
}
.ability-line { margin-bottom: 3px; }
.ability-name { font-weight: 700; }

/* MODAL */
#modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.85); z-index: 500;
  align-items: center; justify-content: center;
  padding: 24px; backdrop-filter: blur(4px);
}
#modal-overlay.active { display: flex; }
#modal-box {
  background: #fff; border-radius: 10px; overflow: hidden;
  max-width: 600px; width: 100%; max-height: 85vh;
  overflow-y: auto; box-shadow: 0 8px 48px rgba(0,0,0,0.7);
  color: #222; font-family: 'EB Garamond', serif;
}
.modal-header {
  display: flex; align-items: flex-start; justify-content: space-between;
  gap: 10px; padding: 14px 16px; position: sticky; top: 0;
}
.modal-title-block { flex: 1; }
.modal-title {
  font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.2rem;
  letter-spacing: 0.05em; text-transform: uppercase; color: #fff;
  text-shadow: 0 1px 4px rgba(0,0,0,0.35);
}
.modal-subtitle { font-size: 0.85rem; color: rgba(255,255,255,0.75); font-style: italic; margin-top: 2px; }
.modal-close {
  font-family: 'Cinzel', serif; font-size: 0.7rem; font-weight: 600;
  background: rgba(0,0,0,0.25); border: none; color: rgba(255,255,255,0.9);
  border-radius: 4px; padding: 5px 12px; cursor: pointer; flex-shrink: 0; transition: background 0.15s;
}
.modal-close:hover { background: rgba(0,0,0,0.4); }
.modal-body { padding: 16px; }
.modal-stat-grid {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 8px; margin-bottom: 14px;
}
.modal-stat-box {
  background: #f7f5f0; border-radius: 5px; padding: 7px 8px; text-align: center;
}
.modal-stat-box .label { font-family: 'Cinzel', serif; font-size: 0.58rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: #888; }
.modal-stat-box .val { font-family: 'Cinzel', serif; font-weight: 700; font-size: 1rem; color: #222; }
.modal-section { margin-top: 12px; }
.modal-section-label {
  font-family: 'Cinzel', serif; font-size: 0.7rem; font-weight: 700;
  letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 6px;
  padding-bottom: 3px; border-bottom: 1px solid #eee;
}
.modal-ability { margin-bottom: 5px; font-size: 0.9rem; color: #333; line-height: 1.45; }
.modal-ability-name { font-weight: 700; }
.modal-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 10px; }
.ability-scores {
  display: grid; grid-template-columns: repeat(6, 1fr);
  gap: 5px; margin-bottom: 14px;
}
.ability-score-box {
  background: #f7f5f0; border-radius: 5px; padding: 6px 4px; text-align: center;
}
.ability-score-box .ab-label { font-family: 'Cinzel', serif; font-size: 0.56rem; font-weight: 700; letter-spacing: 0.1em; color: #888; text-transform: uppercase; }
.ability-score-box .ab-score { font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.9rem; color: #222; }
.ability-score-box .ab-mod { font-size: 0.72rem; color: #555; }

.btn { font-family: 'Cinzel', serif; font-size: 0.75rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; border: none; border-radius: 4px; padding: 7px 16px; cursor: pointer; transition: all 0.15s ease; }
.btn-print { background: linear-gradient(135deg, #c9a84c, #8a6a2c); color: #1a1a2e; font-weight: 700; box-shadow: 0 2px 12px rgba(201,168,76,0.3); }
.btn-print:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(201,168,76,0.5); }

@media print {
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  body > *:not(#print-output) { display: none !important; }
  #print-output { display: block !important; }
  @page { size: A4 landscape; margin: 0; }
  .print-page { page-break-after: always; display: grid !important; grid-template-columns: repeat(4, 1fr) !important; grid-template-rows: repeat(2, 1fr) !important; gap: 3mm !important; padding: 8mm !important; width: 297mm !important; height: 210mm !important; overflow: hidden !important; background: #fff !important; }
  .print-page:last-child { page-break-after: avoid; }
  .print-page .mon-card { border-radius: 4px !important; font-size: 0.52rem !important; }
  .print-page .card-header { padding: 5px 7px !important; }
  .print-page .card-name { font-size: 0.6rem !important; }
  .print-page .cr-badge { font-size: 0.54rem !important; }
  .print-page .stat-label { font-size: 0.5rem !important; }
  .print-page .stat-val { font-size: 0.56rem !important; }
  .print-page .trait-tag { font-size: 0.44rem !important; }
  .print-page .ability-line { font-size: 0.5rem !important; }
  .print-page .card-stats-block { padding: 4px 7px 3px !important; }
}

#btn-filter-toggle { display: none; }
@media (max-width: 768px) {
  #card-grid { grid-template-columns: 1fr 1fr; gap: 12px; padding: 14px; }
  .header-top { padding: 8px 14px; }
  .app-title { font-size: clamp(0.75rem, 3.5vw, 1.1rem); }
  .app-title span { display: none; }
  .btn-print { display: none; }
  #btn-filter-toggle { display: flex; align-items: center; gap: 4px; font-size: 0.7rem; padding: 4px 10px; background: rgba(201,168,76,0.15); border: 1px solid rgba(201,168,76,0.4); color: var(--gold); border-radius: 6px; cursor: pointer; font-family: 'Cinzel', serif; font-weight: 600; letter-spacing: 0.05em; }
  .filter-bar { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 14px; }
  .filter-bar.expanded { max-height: 500px; padding: 10px 14px 12px; }
}
@media (max-width: 480px) { #card-grid { grid-template-columns: 1fr; } }
#print-output { display: none; }

/* ============================================================
   SHARED HAMBURGER NAV
   ============================================================ */
.nav-overlay {
  position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:998;
  opacity:0;pointer-events:none;transition:opacity 0.25s ease;
}
.nav-overlay.open{opacity:1;pointer-events:all;}
.nav-drawer {
  position:fixed;top:0;right:-310px;width:290px;height:100vh;
  background:rgba(13,20,45,0.99);border-left:1px solid var(--border);
  backdrop-filter:blur(16px);z-index:999;
  transition:right 0.28s cubic-bezier(0.4,0,0.2,1);
  display:flex;flex-direction:column;
}
.nav-drawer.open{right:0;}
.nav-drawer-header {
  display:flex;align-items:center;justify-content:space-between;
  padding:18px 20px;border-bottom:1px solid var(--border);flex-shrink:0;
}
.nav-drawer-title {
  font-family:'Cinzel',serif;font-size:0.75rem;font-weight:700;
  letter-spacing:0.18em;text-transform:uppercase;color:var(--gold);
}
.nav-close-btn {
  background:none;border:none;color:var(--text-muted);font-size:1.3rem;
  cursor:pointer;padding:4px 6px;line-height:1;border-radius:4px;transition:color 0.15s;
}
.nav-close-btn:hover{color:var(--text-light);}
.nav-scroll{flex:1;overflow-y:auto;padding:8px 0 24px;}
.nav-section-label {
  font-family:'Cinzel',serif;font-size:0.58rem;font-weight:700;
  letter-spacing:0.22em;text-transform:uppercase;color:var(--text-dim);
  padding:16px 20px 6px;display:block;
}
.nav-item {
  display:flex;align-items:center;gap:12px;padding:11px 20px;
  text-decoration:none;color:var(--text-muted);
  font-family:'Cinzel',serif;font-size:0.75rem;font-weight:600;
  letter-spacing:0.07em;text-transform:uppercase;
  border-left:3px solid transparent;transition:all 0.14s;
}
.nav-item:hover,.nav-item.active{
  color:var(--gold);background:rgba(201,168,76,0.07);border-left-color:var(--gold-dim);
}
.nav-item .ni{font-size:1rem;flex-shrink:0;}
.hamburger-btn {
  background:none;border:1px solid var(--border);border-radius:6px;
  padding:7px 10px;cursor:pointer;display:flex;flex-direction:column;
  gap:5px;transition:border-color 0.15s;flex-shrink:0;
}
.hamburger-btn:hover{border-color:var(--gold-dim);}
.hamburger-btn span{
  display:block;width:20px;height:2px;background:var(--text-muted);
  border-radius:2px;transition:background 0.15s;
}
.hamburger-btn:hover span{background:var(--gold);}
</style>
</head>
<body>

<!-- SHARED NAV DRAWER -->
<div class="nav-overlay" id="nav-overlay" onclick="closeNav()"></div>
<nav class="nav-drawer" id="nav-drawer">
  <div class="nav-drawer-header">
    <span class="nav-drawer-title">The Tome</span>
    <button class="nav-close-btn" onclick="closeNav()">&#x2715;</button>
  </div>
  <div class="nav-scroll">
    <span class="nav-section-label">Home</span>
    <a href="index.html" class="nav-item"><span class="ni">&#x1F4D6;</span>&nbsp;Hub</a>
    <span class="nav-section-label">Tools</span>
    <a href="spelltome.html" class="nav-item"><span class="ni">&#x2728;</span>&nbsp;Spell Tome</a>
    <a href="conditions.html" class="nav-item"><span class="ni">&#x26A0;&#xFE0F;</span>&nbsp;Condition Codex</a>
    <a href="wildshape.html" class="nav-item"><span class="ni">&#x1F43E;</span>&nbsp;Wildshape &amp; Familiar</a>
    <a href="monsters.html" class="nav-item active"><span class="ni">&#x1F409;</span>&nbsp;Monster Codex</a>
    <a href="magic-items.html" class="nav-item"><span class="ni">&#x1F48D;</span>&nbsp;Magic Item Compendium</a>
  </div>
</nav>

<div id="app-header">
  <div class="header-top">
    <div class="app-title">Monster Codex <span>D&D 5e Quick Reference</span></div>
    <div style="display:flex;align-items:center;gap:12px;">
      <button class="btn btn-print" onclick="printCards()" style="display:none;" id="btn-print-top">Print to PDF</button>
      <button id="btn-filter-toggle" onclick="toggleFilters()">Filters <span id="toggle-arrow">‚ñº</span></button>
      <button class="hamburger-btn" onclick="openNav()" aria-label="Open navigation"><span></span><span></span><span></span></button>
    </div>
  </div>
  <div class="filter-bar" id="filter-bar">
    <span class="filter-label">Search</span>
    <input type="text" class="search-input" id="search-input" placeholder="Search monsters‚Ä¶" oninput="applyFilters()">
    <span class="filter-label">CR</span>
    <select id="cr-min" onchange="applyFilters()">
      <option value="">Min</option>
      <option value="0">0</option><option value="0.125">1/8</option><option value="0.25">1/4</option>
      <option value="0.5">1/2</option><option value="1">1</option><option value="2">2</option>
      <option value="3">3</option><option value="4">4</option><option value="5">5</option>
      <option value="6">6</option><option value="7">7</option><option value="8">8</option>
      <option value="9">9</option><option value="10">10</option><option value="11">11</option>
      <option value="12">12</option><option value="13">13</option><option value="14">14</option>
      <option value="15">15</option><option value="17">17</option><option value="20">20</option>
      <option value="21">21</option><option value="23">23</option><option value="24">24</option>
      <option value="30">30</option>
    </select>
    <select id="cr-max" onchange="applyFilters()">
      <option value="">Max</option>
      <option value="0">0</option><option value="0.125">1/8</option><option value="0.25">1/4</option>
      <option value="0.5">1/2</option><option value="1">1</option><option value="2">2</option>
      <option value="3">3</option><option value="4">4</option><option value="5">5</option>
      <option value="6">6</option><option value="7">7</option><option value="8">8</option>
      <option value="9">9</option><option value="10">10</option><option value="11">11</option>
      <option value="12">12</option><option value="13">13</option><option value="14">14</option>
      <option value="15">15</option><option value="17">17</option><option value="20">20</option>
      <option value="21">21</option><option value="23">23</option><option value="24">24</option>
      <option value="30">30</option>
    </select>
    <div class="filter-divider"></div>
    <span class="filter-label">Type</span>
    <div class="pill-filters" id="type-pills"></div>
    <div class="filter-divider"></div>
    <span class="filter-label">Size</span>
    <div class="pill-filters" id="size-pills">
      <div class="pill active" data-val="all" onclick="togglePill(this,'size')">All</div>
      <div class="pill" data-val="Tiny" onclick="togglePill(this,'size')">Tiny</div>
      <div class="pill" data-val="Small" onclick="togglePill(this,'size')">Small</div>
      <div class="pill" data-val="Medium" onclick="togglePill(this,'size')">Medium</div>
      <div class="pill" data-val="Large" onclick="togglePill(this,'size')">Large</div>
      <div class="pill" data-val="Huge" onclick="togglePill(this,'size')">Huge</div>
      <div class="pill" data-val="Gargantuan" onclick="togglePill(this,'size')">Garg.</div>
    </div>
    <button class="btn-reset" onclick="resetFilters()">Reset</button>
  </div>
</div>
<div id="results-bar"></div>
<div id="card-grid"></div>
<div id="empty-state" style="display:none;">
  <span class="rune">üêâ</span>
  <h2>No Monsters Found</h2>
  <p>Adjust your filters to find your quarry.</p>
</div>
<div id="modal-overlay" onclick="handleModalClick(event)">
  <div id="modal-box"></div>
</div>
<div id="print-output"></div>

<script>
const TYPE_COLORS = {
  aberration:'#6a3a8a', beast:'#4a7a2a', celestial:'#b8902a', construct:'#5a6a7a',
  dragon:'#8a2a2a', elemental:'#3a6a8a', fey:'#c4306a', fiend:'#7a1a1a',
  giant:'#7a5a2a', humanoid:'#4a5a6a', monstrosity:'#5a3a6a', ooze:'#3a7a3a',
  plant:'#2a6a3a', undead:'#3a3a5a'
};

function cr(n) { if(n===0.125)return'1/8'; if(n===0.25)return'1/4'; if(n===0.5)return'1/2'; return String(n); }
function mod(n) { const m=Math.floor((n-10)/2); return (m>=0?'+':'')+m; }

const MONSTERS = [
  // CR 0 ‚Äî 1/4
  {name:'Awakened Shrub',cr:0,size:'Small',type:'plant',ac:9,hp:10,speed:'20 ft',str:3,dex:8,con:11,int:10,wis:10,cha:6,
    dmgImmune:['fire'],senses:'Passive Perception 10',
    abilities:[{n:'False Appearance',t:'While motionless, indistinguishable from a normal shrub.'}],
    actions:[{n:'Rake',t:'+1 to hit, 1d4-1 slashing.'}]},
  {name:'Bat',cr:0,size:'Tiny',type:'beast',ac:12,hp:1,speed:'5 ft, fly 30 ft',str:2,dex:15,con:8,int:2,wis:12,cha:4,
    senses:'Blindsight 60 ft, Passive Perception 11',
    abilities:[{n:'Echolocation',t:'Cannot use blindsight while deafened.'},{n:'Keen Hearing',t:'Advantage on Perception checks relying on hearing.'}],
    actions:[{n:'Bite',t:'+0 to hit, 1 piercing.'}]},
  {name:'Cat',cr:0.125,size:'Tiny',type:'beast',ac:12,hp:2,speed:'40 ft, climb 30 ft',str:3,dex:15,con:10,int:3,wis:12,cha:7,
    skills:'Perception +3, Stealth +4',senses:'Darkvision 30 ft, Passive Perception 13',
    abilities:[{n:'Keen Smell',t:'Advantage on Perception checks relying on smell.'}],
    actions:[{n:'Claws',t:'+0 to hit, 1 slashing.'}]},
  {name:'Giant Rat',cr:0.125,size:'Small',type:'beast',ac:12,hp:7,speed:'30 ft',str:7,dex:15,con:11,int:2,wis:10,cha:4,
    senses:'Darkvision 60 ft, Passive Perception 10',
    abilities:[{n:'Keen Smell',t:'Advantage on Perception checks relying on smell.'},{n:'Pack Tactics',t:'Advantage on attack rolls against a creature if an ally is adjacent to it.'}],
    actions:[{n:'Bite',t:'+4 to hit, 2d4+2 piercing.'}]},
  {name:'Kobold',cr:0.125,size:'Small',type:'humanoid',ac:12,hp:5,speed:'30 ft',str:7,dex:15,con:9,int:8,wis:7,cha:8,
    senses:'Darkvision 60 ft, Passive Perception 8',
    abilities:[{n:'Sunlight Sensitivity',t:'Disadvantage on attacks and Perception in sunlight.'},{n:'Pack Tactics',t:'Advantage on attacks if ally is adjacent to target.'}],
    actions:[{n:'Dagger',t:'+4 to hit, 1d4+2 piercing.'},{n:'Sling',t:'+4 to hit, 60/240 ft, 1d4+2 bludgeoning.'}]},
  {name:'Skeleton',cr:0.25,size:'Medium',type:'undead',ac:13,hp:13,speed:'30 ft',str:10,dex:14,con:15,int:6,wis:8,cha:5,
    dmgVuln:['bludgeoning'],dmgImmune:['poison'],condImmune:['exhaustion','poisoned'],
    senses:'Darkvision 60 ft, Passive Perception 9',
    actions:[{n:'Shortsword',t:'+4 to hit, 1d6+2 piercing.'},{n:'Shortbow',t:'+4 to hit, 80/320 ft, 1d6+2 piercing.'}]},
  {name:'Wolf',cr:0.25,size:'Medium',type:'beast',ac:13,hp:11,speed:'40 ft',str:12,dex:15,con:12,int:3,wis:12,cha:6,
    skills:'Perception +3, Stealth +4',senses:'Passive Perception 13',
    abilities:[{n:'Keen Hearing and Smell',t:'Advantage on Perception relying on hearing or smell.'},{n:'Pack Tactics',t:'Advantage on attacks if ally is adjacent to target.'}],
    actions:[{n:'Bite',t:'+4 to hit, 2d4+2 piercing. DC 11 Str or knocked prone.'}]},
  {name:'Zombie',cr:0.25,size:'Medium',type:'undead',ac:8,hp:22,speed:'20 ft',str:13,dex:6,con:16,int:3,wis:6,cha:5,
    savingThrows:'Wis +0',dmgImmune:['poison'],condImmune:['poisoned'],
    senses:'Darkvision 60 ft, Passive Perception 8',
    abilities:[{n:'Undead Fortitude',t:'On being reduced to 0 HP by damage (not radiant or crit), make Con save DC 5+damage or drop to 1 HP instead.'}],
    actions:[{n:'Slam',t:'+3 to hit, 1d6+1 bludgeoning.'}]},
  // CR 1
  {name:'Bugbear',cr:1,size:'Medium',type:'humanoid',ac:16,hp:27,speed:'30 ft',str:15,dex:14,con:13,int:8,wis:11,cha:9,
    skills:'Stealth +6, Survival +2',senses:'Darkvision 60 ft, Passive Perception 10',
    abilities:[{n:'Brute',t:'Deals one extra die of weapon damage on a hit (included).'},{n:'Surprise Attack',t:'Extra 2d6 damage if surprises a creature and hits in the first round.'}],
    actions:[{n:'Morningstar',t:'+4 to hit, 2d8+2 piercing.'},{n:'Javelin',t:'+4 to hit, 30/120 ft, 2d6+2 piercing.'}]},
  {name:'Dire Wolf',cr:1,size:'Large',type:'beast',ac:14,hp:37,speed:'50 ft',str:17,dex:15,con:15,int:3,wis:12,cha:7,
    skills:'Perception +3, Stealth +4',senses:'Passive Perception 13',
    abilities:[{n:'Keen Hearing and Smell',t:'Advantage on Perception relying on hearing or smell.'},{n:'Pack Tactics',t:'Advantage on attacks if ally is adjacent to target.'}],
    actions:[{n:'Bite',t:'+5 to hit, 2d6+3 piercing. DC 13 Str or knocked prone.'}]},
  {name:'Ghoul',cr:1,size:'Medium',type:'undead',ac:12,hp:22,speed:'30 ft',str:13,dex:15,con:10,int:7,wis:10,cha:6,
    dmgImmune:['poison'],condImmune:['charmed','exhaustion','poisoned'],
    senses:'Darkvision 60 ft, Passive Perception 10',
    actions:[{n:'Claws',t:'+4 to hit, 2d4+2 slashing. DC 10 Con or paralyzed until end of next turn (not on elves).'},{n:'Bite',t:'+2 to hit, 2d6+0 piercing.'}]},
  {name:'Giant Spider',cr:1,size:'Large',type:'beast',ac:14,hp:26,speed:'30 ft, climb 30 ft',str:14,dex:16,con:12,int:2,wis:11,cha:4,
    skills:'Stealth +7',senses:'Blindsight 10 ft, Darkvision 60 ft, Passive Perception 10',
    abilities:[{n:'Spider Climb',t:'Can climb difficult surfaces including ceilings.'},{n:'Web Sense',t:'Knows exact location of anything touching its web.'},{n:'Web Walker',t:'Ignores web movement restrictions.'}],
    actions:[{n:'Bite',t:'+5 to hit, 1d8+3 piercing + 2d8 poison. DC 11 Con or poisoned for 1 hour; if fails by 5+, also unconscious.'},{n:'Web (Recharge 5-6)',t:'+5 to hit, 30/60 ft, restrained until DC 12 Str check.'}]},
  // CR 2
  {name:'Ogre',cr:2,size:'Large',type:'giant',ac:11,hp:59,speed:'40 ft',str:19,dex:8,con:16,int:5,wis:7,cha:7,
    senses:'Darkvision 60 ft, Passive Perception 8',
    actions:[{n:'Greatclub',t:'+6 to hit, 2d8+4 bludgeoning.'},{n:'Javelin',t:'+6 to hit, 30/120 ft, 2d6+4 piercing.'}]},
  {name:'Werewolf',cr:3,size:'Medium',type:'humanoid',ac:11,hp:58,speed:'30 ft (40 ft wolf form)',str:15,dex:13,con:14,int:10,wis:11,cha:10,
    skills:'Perception +4, Stealth +3',
    dmgImmune:['bludgeoning','piercing','slashing from nonmagical non-silvered weapons'],
    senses:'Passive Perception 14',
    abilities:[{n:'Shapechanger',t:'Can polymorph into wolf-humanoid hybrid or wolf; reverts on death.'},{n:'Keen Hearing and Smell',t:'Advantage on Perception relying on hearing or smell.'}],
    actions:[{n:'Multiattack (Hybrid)',t:'Two attacks: one Bite and one Claws.'},{n:'Bite (Wolf/Hybrid)',t:'+4 to hit, 2d6+2 piercing. DC 12 Con or cursed with lycanthropy.'},{n:'Claws (Hybrid)',t:'+4 to hit, 2d4+2 slashing.'}]},
  {name:'Basilisk',cr:3,size:'Medium',type:'monstrosity',ac:15,hp:52,speed:'20 ft',str:16,dex:8,con:15,int:2,wis:8,cha:7,
    senses:'Darkvision 60 ft, Passive Perception 9',
    abilities:[{n:'Petrifying Gaze',t:'DC 12 Con save or restrained; repeat each turn or become petrified for 24 hours.'}],
    actions:[{n:'Bite',t:'+5 to hit, 2d6+3 piercing + 2d6 poison.'}]},
  // CR 4-6
  {name:'Banshee',cr:4,size:'Medium',type:'undead',ac:12,hp:58,speed:'0 ft, fly 40 ft (hover)',str:1,dex:14,con:10,int:12,wis:11,cha:17,
    dmgImmune:['cold','lightning','necrotic','poison'],
    dmgResist:['acid','fire','thunder','bludgeoning','piercing','slashing from non-magic'],
    condImmune:['charmed','exhaustion','frightened','grappled','paralyzed','petrified','poisoned','prone','restrained'],
    savingThrows:'Wis +2, Cha +5',senses:'Darkvision 60 ft, Passive Perception 10',
    abilities:[{n:'Incorporeal Movement',t:'Can pass through objects; 1d10 force damage if ending turn inside one.'},{n:'Undead Nature',t:'Does not require air, food, drink, or sleep.'}],
    actions:[{n:'Corrupting Touch',t:'+4 to hit, 3d6 necrotic.'},{n:'Horrifying Visage',t:'Each non-undead within 60 ft, DC 13 Wis or frightened for 1 minute.'},{n:'Wail (1/day)',t:'Each living creature within 30 ft, DC 13 Con or drop to 0 HP. On save, 3d6+3 psychic.'}]},
  {name:'Owlbear',cr:3,size:'Large',type:'monstrosity',ac:13,hp:59,speed:'40 ft',str:20,dex:12,con:17,int:3,wis:12,cha:7,
    skills:'Perception +3',senses:'Darkvision 60 ft, Passive Perception 13',
    abilities:[{n:'Keen Sight and Smell',t:'Advantage on Perception relying on sight or smell.'}],
    actions:[{n:'Multiattack',t:'Two attacks: Beak and Claws.'},{n:'Beak',t:'+7 to hit, 1d10+5 piercing.'},{n:'Claws',t:'+7 to hit, 2d8+5 slashing.'}]},
  {name:'Troll',cr:5,size:'Large',type:'giant',ac:15,hp:84,speed:'30 ft',str:18,dex:13,con:20,int:7,wis:9,cha:7,
    skills:'Perception +2',senses:'Darkvision 60 ft, Passive Perception 12',
    abilities:[{n:'Keen Smell',t:'Advantage on Perception relying on smell.'},{n:'Regeneration',t:'Regains 10 HP at start of turn unless it took acid or fire damage since last turn. Dies at 0 HP only if it cannot regenerate.'}],
    actions:[{n:'Multiattack',t:'Three attacks: one Bite and two Claws.'},{n:'Bite',t:'+7 to hit, 1d6+4 piercing.'},{n:'Claw',t:'+7 to hit, 2d6+4 slashing.'}]},
  {name:'Medusa',cr:6,size:'Medium',type:'monstrosity',ac:15,hp:127,speed:'30 ft',str:10,dex:15,con:16,int:12,wis:13,cha:15,
    skills:'Deception +5, Insight +4, Perception +4, Stealth +5',
    senses:'Darkvision 60 ft, Passive Perception 14',
    abilities:[{n:'Petrifying Gaze',t:'DC 14 Con save or restrained; fail again: petrified 24 hrs. Looking away: disadvantage on attacks, she has advantage.'}],
    actions:[{n:'Multiattack',t:'Three attacks: one Snake Hair and two Shortswords or two Longbows.'},{n:'Snake Hair',t:'+5 to hit, 1d4+3 piercing + 4d6 poison.'},{n:'Shortsword',t:'+5 to hit, 1d6+3 piercing.'},{n:'Longbow',t:'+5 to hit, 150/600 ft, 1d8+3 piercing.'}]},
  // CR 7-10
  {name:'Stone Giant',cr:7,size:'Huge',type:'giant',ac:17,hp:126,speed:'40 ft',str:23,dex:15,con:20,int:10,wis:12,cha:9,
    savingThrows:'Dex +5, Con +8, Wis +4',skills:'Athletics +12, Perception +4',
    senses:'Darkvision 60 ft, Passive Perception 14',
    abilities:[{n:'Stone Camouflage',t:'Advantage on Stealth in rocky terrain.'}],
    actions:[{n:'Multiattack',t:'Two Greatclub attacks.'},{n:'Greatclub',t:'+9 to hit, 3d8+6 bludgeoning.'},{n:'Rock',t:'+9 to hit, 60/240 ft, 4d10+6 bludgeoning. DC 17 Str or knocked prone.'}]},
  {name:'Hydra',cr:8,size:'Huge',type:'monstrosity',ac:15,hp:172,speed:'30 ft, swim 30 ft',str:20,dex:12,con:20,int:2,wis:10,cha:7,
    skills:'Perception +6',senses:'Darkvision 60 ft, Passive Perception 16',
    abilities:[{n:'Hold Breath',t:'Can hold breath for 1 hour.'},{n:'Multiple Heads',t:'Starts with 5 heads; advantage on Perception, Wis saves, disadvantage on sleep. While conscious, cannot be surprised. Each head HP threshold: when reduced by 25+ damage in one turn, a head is severed (unless fire damage). Grows 2 heads at end of turn up to 3 beyond original count.'},{n:'Reactive Heads',t:'For each head beyond one, gains an extra reaction for opportunity attacks.'}],
    actions:[{n:'Multiattack',t:'One Bite per head.'},{n:'Bite',t:'+8 to hit, 2d6+5 piercing.'}]},
  {name:'Aboleth',cr:10,size:'Large',type:'aberration',ac:17,hp:135,speed:'10 ft, swim 40 ft',str:21,dex:9,con:15,int:18,wis:15,cha:18,
    savingThrows:'Con +6, Int +8, Wis +6',skills:'History +12, Perception +10',
    senses:'Darkvision 120 ft, Passive Perception 20',legendary:true,
    abilities:[{n:'Amphibious',t:'Can breathe air and water.'},{n:'Mucous Cloud',t:'Underwater, surrounded by mucus; on touch, DC 14 Con or need to breathe water for 3 hours.'},{n:'Probing Telepathy',t:'Learns surface thoughts of creature it converses with.'}],
    actions:[{n:'Multiattack',t:'Three Tentacle attacks.'},{n:'Tentacle',t:'+9 to hit, 2d6+5 bludgeoning. Target grappled/restrained; DC 14 Con or diseased.'},{n:'Tail',t:'+9 to hit, 3d6+5 bludgeoning.'},{n:'Enslave (3/day)',t:'DC 14 Wis or charmed for 24 hours, obeying telepathic commands.'}],
    legendaryActions:[{n:'Detect',t:'Perception check.'},{n:'Tail Swipe',t:'Tail attack.'},{n:'Psychic Drain (2)',t:'Target charmed: 3d6 psychic, aboleth regains same HP.'}]},
  // CR 11+
  {name:'Adult Red Dragon',cr:17,size:'Huge',type:'dragon',ac:19,hp:256,speed:'40 ft, climb 40 ft, fly 80 ft',str:27,dex:10,con:25,int:16,wis:13,cha:21,
    savingThrows:'Dex +6, Con +13, Wis +7, Cha +11',
    skills:'Perception +13, Stealth +6',
    dmgImmune:['fire'],senses:'Blindsight 60 ft, Darkvision 120 ft, Passive Perception 23',legendary:true,
    abilities:[{n:'Legendary Resistance (3/day)',t:'If fails a saving throw, chooses to succeed instead.'}],
    actions:[{n:'Multiattack',t:'One Bite and two Claw attacks.'},{n:'Bite',t:'+14 to hit, 2d10+8 piercing + 4d6 fire.'},{n:'Claw',t:'+14 to hit, 2d6+8 slashing.'},{n:'Fire Breath (Recharge 5-6)',t:'60 ft cone. DC 21 Dex or 18d6 fire; half on save.'}],
    legendaryActions:[{n:'Detect',t:'Perception check.'},{n:'Tail Attack',t:'+14 hit, 2d8+8 bludgeoning.'},{n:'Wing Attack (2)',t:'DC 22 Dex or 2d6+8 bludgeoning, knocked prone. Dragon then flies up to half speed.'}]},
  {name:'Ancient Green Dragon',cr:22,size:'Gargantuan',type:'dragon',ac:21,hp:385,speed:'40 ft, fly 80 ft, swim 40 ft',str:27,dex:12,con:25,int:20,wis:17,cha:19,
    savingThrows:'Dex +8, Con +14, Wis +10, Cha +11',
    skills:'Deception +11, Insight +10, Perception +17, Persuasion +11, Stealth +8',
    dmgImmune:['poison'],condImmune:['poisoned'],
    senses:'Blindsight 60 ft, Darkvision 120 ft, Passive Perception 27',legendary:true,
    abilities:[{n:'Amphibious',t:'Can breathe air and water.'},{n:'Legendary Resistance (3/day)',t:'Choose to succeed on failed save.'}],
    actions:[{n:'Multiattack',t:'One Bite and two Claw attacks.'},{n:'Bite',t:'+15 to hit, 2d10+8 piercing + 4d6 poison.'},{n:'Poison Breath (Recharge 5-6)',t:'90 ft cone. DC 22 Con or 22d6 poison; half on save.'}],
    legendaryActions:[{n:'Detect',t:'Perception check.'},{n:'Tail Attack',t:'+15 hit.'},{n:'Wing Attack (2)',t:'DC 23 Dex or knocked prone.'}]},
  {name:'Lich',cr:21,size:'Medium',type:'undead',ac:17,hp:135,speed:'30 ft',str:11,dex:16,con:16,int:20,wis:14,cha:16,
    savingThrows:'Con +10, Int +12, Wis +9',
    skills:'Arcana +19, History +12, Insight +9, Perception +9',
    dmgImmune:['cold','lightning','necrotic','poison'],
    dmgResist:['bludgeoning','piercing','slashing from non-magic'],
    condImmune:['charmed','exhaustion','frightened','paralyzed','poisoned'],
    senses:'Truesight 120 ft, Passive Perception 19',legendary:true,spellcaster:true,
    abilities:[{n:'Legendary Resistance (3/day)',t:'Choose to succeed on failed save.'},{n:'Rejuvenation',t:'If destroyed and has phylactery, regains a body in 1d10 days.'},{n:'Spellcasting',t:'18th-level wizard; spell save DC 20. Prepared spells include: Detect Magic, Fireball, Counterspell, Plane Shift, Power Word Kill and more.'}],
    actions:[{n:'Paralyzing Touch',t:'+8 to hit, 3d6 cold. DC 18 Con or paralyzed for 1 minute; repeat save each turn.'},{n:'Frightening Gaze',t:'DC 18 Wis or frightened for 1 minute.'}],
    legendaryActions:[{n:'Cantrip',t:'Cast a cantrip.'},{n:'Paralyzing Touch (2)',t:'Paralyzing Touch.'},{n:'Frightening Gaze (2)',t:'Frightening Gaze.'},{n:'Disrupt Life (3)',t:'All living creatures within 20 ft, DC 18 Con or 6d6 necrotic.'}]},
  {name:'Balor',cr:19,size:'Huge',type:'fiend',ac:19,hp:262,speed:'40 ft, fly 80 ft',str:26,dex:15,con:22,int:20,wis:16,cha:22,
    savingThrows:'Str +14, Con +12, Wis +9, Cha +12',
    skills:'Perception +9',
    dmgImmune:['fire','poison'],
    dmgResist:['cold','lightning','bludgeoning','piercing','slashing from non-magic/non-silvered'],
    condImmune:['poisoned'],
    senses:'Truesight 120 ft, Passive Perception 19',legendary:false,
    abilities:[{n:'Death Throes',t:'On death: explodes. DC 20 Dex or 20d6 fire; half on save. Also destroys non-artifact items within 10 ft.'},{n:'Fire Aura',t:'Start of each turn: 10 ft radius, 3d6 fire. Also ignites flammable objects.'},{n:'Magic Resistance',t:'Advantage on saving throws against spells and magical effects.'}],
    actions:[{n:'Multiattack',t:'Two attacks: Vorpal Sword and Whip.'},{n:'Vorpal Sword',t:'+14 to hit, 3d8+8 slashing + 3d8 lightning.'},{n:'Whip',t:'+14 to hit, 2d6+8 slashing + 3d6 fire. DC 20 Str or pulled 25 ft toward the balor.'}]},
];

const TYPES = [...new Set(MONSTERS.map(m => m.type))].sort();
let activeTypes = new Set(['all']);
let activeSizes = new Set(['all']);
let searchQ = '';

function initPills() {
  const tp = document.getElementById('type-pills');
  tp.innerHTML = `<div class="pill active" data-val="all" onclick="togglePill(this,'type')">All</div>` +
    TYPES.map(t => `<div class="pill" data-val="${t}" onclick="togglePill(this,'type')"
      style="${activeTypes.has(t)?'background:'+TYPE_COLORS[t]+';color:#fff;border-color:transparent':''}"
    >${t.charAt(0).toUpperCase()+t.slice(1)}</div>`).join('');
}

function togglePill(pill, group) {
  const val = pill.dataset.val;
  const set = group === 'type' ? activeTypes : activeSizes;
  const pillsId = group === 'type' ? 'type-pills' : 'size-pills';
  if (val === 'all') { set.clear(); set.add('all'); }
  else {
    set.delete('all');
    if (set.has(val)) { set.delete(val); if (set.size === 0) set.add('all'); }
    else set.add(val);
  }
  document.querySelectorAll(`#${pillsId} .pill`).forEach(p => {
    const v = p.dataset.val;
    const isActive = set.has(v);
    p.classList.toggle('active', isActive);
    if (group === 'type' && v !== 'all' && isActive) {
      p.style.background = TYPE_COLORS[v] || '#666';
      p.style.color = '#fff';
      p.style.borderColor = 'transparent';
    } else if (group === 'type' && v !== 'all') {
      p.style.background = ''; p.style.color = ''; p.style.borderColor = '';
    }
  });
  renderGrid();
}

function applyFilters() { searchQ = document.getElementById('search-input').value.toLowerCase().trim(); renderGrid(); }

function resetFilters() {
  document.getElementById('search-input').value = '';
  document.getElementById('cr-min').value = '';
  document.getElementById('cr-max').value = '';
  searchQ = ''; activeTypes = new Set(['all']); activeSizes = new Set(['all']);
  initPills();
  document.querySelectorAll('#size-pills .pill').forEach(p => p.classList.toggle('active', p.dataset.val === 'all'));
  renderGrid();
}

function filtered() {
  const crMin = document.getElementById('cr-min').value;
  const crMax = document.getElementById('cr-max').value;
  return MONSTERS.filter(m => {
    const typeOk = activeTypes.has('all') || activeTypes.has(m.type);
    const sizeOk = activeSizes.has('all') || activeSizes.has(m.size);
    const crMinOk = !crMin || m.cr >= parseFloat(crMin);
    const crMaxOk = !crMax || m.cr <= parseFloat(crMax);
    const searchOk = !searchQ || m.name.toLowerCase().includes(searchQ) || m.type.includes(searchQ);
    return typeOk && sizeOk && crMinOk && crMaxOk && searchOk;
  });
}

function buildCard(m) {
  const color = TYPE_COLORS[m.type] || '#555';
  const tags = [];
  if (m.legendary) tags.push(`<span class="trait-tag legendary">Legendary</span>`);
  if (m.spellcaster) tags.push(`<span class="trait-tag spellcaster">Spellcaster</span>`);
  if (m.dmgImmune?.length) tags.push(`<span class="trait-tag dmg-immune">Immune: ${m.dmgImmune.slice(0,3).join(', ')}</span>`);
  if (m.dmgResist?.length) tags.push(`<span class="trait-tag dmg-resist">Resist: ${m.dmgResist.slice(0,2).join(', ')}</span>`);
  if (m.condImmune?.length) tags.push(`<span class="trait-tag cond-immune">Cond. Immune: ${m.condImmune.slice(0,3).join(', ')}</span>`);
  const keyAbility = m.abilities?.[0];
  return `<div class="mon-card" style="border-color:${color}20">
    <div class="card-header" style="background:${color}">
      <div style="flex:1">
        <div class="card-name">${m.name}</div>
        <span class="card-subtype">${m.size} ${m.type.charAt(0).toUpperCase()+m.type.slice(1)}</span>
      </div>
      <span class="cr-badge">CR ${cr(m.cr)}</span>
    </div>
    <div class="card-stats-block">
      <div class="stat-row"><span class="stat-label">AC</span><span class="stat-val">${m.ac}</span></div>
      <div class="stat-row"><span class="stat-label">HP</span><span class="stat-val">${m.hp}</span></div>
      <div class="stat-row"><span class="stat-label">Speed</span><span class="stat-val">${m.speed}</span></div>
      <div class="stat-row"><span class="stat-label">STR</span><span class="stat-val">${m.str} (${mod(m.str)})</span></div>
      <div class="stat-row"><span class="stat-label">DEX</span><span class="stat-val">${m.dex} (${mod(m.dex)})</span></div>
      <div class="stat-row"><span class="stat-label">CON</span><span class="stat-val">${m.con} (${mod(m.con)})</span></div>
    </div>
    ${tags.length ? `<div class="card-traits">${tags.join('')}</div>` : ''}
    ${keyAbility ? `<div class="card-abilities"><div class="ability-line"><span class="ability-name">${keyAbility.n}.</span> ${keyAbility.t.substring(0,120)}${keyAbility.t.length>120?'‚Ä¶':''}</div></div>` : ''}
  </div>`;
}

function renderGrid() {
  const list = filtered();
  const grid = document.getElementById('card-grid');
  const empty = document.getElementById('empty-state');
  document.getElementById('results-bar').textContent = `${list.length} monster${list.length !== 1 ? 's' : ''} shown`;
  if (!list.length) { grid.innerHTML = ''; empty.style.display = 'flex'; return; }
  empty.style.display = 'none';
  grid.innerHTML = list.map(m => buildCard(m)).join('');
  grid.querySelectorAll('.mon-card').forEach((el, i) => el.addEventListener('click', () => openModal(list[i])));
}

function openModal(m) {
  const color = TYPE_COLORS[m.type] || '#555';
  const box = document.getElementById('modal-box');
  const tags = [];
  if (m.legendary) tags.push(`<span class="trait-tag legendary">Legendary</span>`);
  if (m.spellcaster) tags.push(`<span class="trait-tag spellcaster">Spellcaster</span>`);
  if (m.dmgImmune?.length) tags.push(`<span class="trait-tag dmg-immune">Damage Immune: ${m.dmgImmune.join(', ')}</span>`);
  if (m.dmgResist?.length) tags.push(`<span class="trait-tag dmg-resist">Resistant: ${m.dmgResist.join(', ')}</span>`);
  if (m.dmgVuln?.length) tags.push(`<span class="trait-tag" style="background:#fdf;color:#737">Vulnerable: ${m.dmgVuln.join(', ')}</span>`);
  if (m.condImmune?.length) tags.push(`<span class="trait-tag cond-immune">Condition Immune: ${m.condImmune.join(', ')}</span>`);
  box.innerHTML = `
    <div class="modal-header" style="background:${color}">
      <div class="modal-title-block">
        <div class="modal-title">${m.name}</div>
        <div class="modal-subtitle">${m.size} ${m.type.charAt(0).toUpperCase()+m.type.slice(1)} ‚Äî CR ${cr(m.cr)}</div>
      </div>
      <button class="modal-close" onclick="closeModal()">Close</button>
    </div>
    <div class="modal-body">
      <div class="modal-stat-grid">
        <div class="modal-stat-box"><div class="label">AC</div><div class="val">${m.ac}</div></div>
        <div class="modal-stat-box"><div class="label">HP</div><div class="val">${m.hp}</div></div>
        <div class="modal-stat-box"><div class="label">Speed</div><div class="val" style="font-size:0.75rem">${m.speed}</div></div>
        <div class="modal-stat-box"><div class="label">CR</div><div class="val">${cr(m.cr)}</div></div>
      </div>
      <div class="ability-scores">
        ${['STR','DEX','CON','INT','WIS','CHA'].map((ab,i) => {
          const v = [m.str,m.dex,m.con,m.int,m.wis,m.cha][i];
          return `<div class="ability-score-box"><div class="ab-label">${ab}</div><div class="ab-score">${v}</div><div class="ab-mod">${mod(v)}</div></div>`;
        }).join('')}
      </div>
      ${m.savingThrows ? `<div style="font-size:0.85rem;color:#555;margin-bottom:8px;"><strong>Saves:</strong> ${m.savingThrows}</div>` : ''}
      ${m.skills ? `<div style="font-size:0.85rem;color:#555;margin-bottom:8px;"><strong>Skills:</strong> ${m.skills}</div>` : ''}
      ${m.senses ? `<div style="font-size:0.85rem;color:#555;margin-bottom:8px;"><strong>Senses:</strong> ${m.senses}</div>` : ''}
      ${tags.length ? `<div class="modal-tags">${tags.join('')}</div>` : ''}
      ${m.abilities?.length ? `
        <div class="modal-section">
          <div class="modal-section-label" style="color:${color}">Traits</div>
          ${m.abilities.map(a => `<div class="modal-ability"><span class="modal-ability-name">${a.n}.</span> ${a.t}</div>`).join('')}
        </div>` : ''}
      ${m.actions?.length ? `
        <div class="modal-section">
          <div class="modal-section-label" style="color:${color}">Actions</div>
          ${m.actions.map(a => `<div class="modal-ability"><span class="modal-ability-name">${a.n}.</span> ${a.t}</div>`).join('')}
        </div>` : ''}
      ${m.legendaryActions?.length ? `
        <div class="modal-section">
          <div class="modal-section-label" style="color:#b8902a">Legendary Actions (3/turn)</div>
          ${m.legendaryActions.map(a => `<div class="modal-ability"><span class="modal-ability-name">${a.n}.</span> ${a.t}</div>`).join('')}
        </div>` : ''}
    </div>`;
  document.getElementById('modal-overlay').classList.add('active');
}

function handleModalClick(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}
function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); }
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

function toggleFilters() {
  const bar = document.getElementById('filter-bar');
  bar.classList.toggle('expanded');
  document.getElementById('toggle-arrow').textContent = bar.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
}

function printCards() {
  const list = filtered();
  const output = document.getElementById('print-output');
  const pages = [];
  for (let i = 0; i < list.length; i += 8) pages.push(list.slice(i, i + 8));
  output.innerHTML = pages.map(page => `<div class="print-page">${page.map(m => buildCard(m)).join('')}</div>`).join('');
  window.print();
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('cr-min').addEventListener('change', renderGrid);
  document.getElementById('cr-max').addEventListener('change', renderGrid);
  document.getElementById('btn-print-top').style.display = 'block';
  initPills();
  renderGrid();
});
initPills();
renderGrid();
</script>

<script>
function openNav() {
  document.getElementById('nav-drawer').classList.add('open');
  document.getElementById('nav-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeNav() {
  document.getElementById('nav-drawer').classList.remove('open');
  document.getElementById('nav-overlay').classList.remove('open');
  document.body.style.overflow = '';
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeNav(); });
</script>
</body>
</html>
